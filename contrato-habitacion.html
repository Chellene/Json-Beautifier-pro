<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Contrato de Habitación PRO — Generador PDF estilo notaría (1 €)</title>
  <meta name="description" content="Genera un contrato de alquiler de habitación profesional en minutos. Rellena datos, elige cláusulas y descarga un PDF estilo notaría por 1 €. Pago seguro por PayPal." />
  <meta name="robots" content="index,follow,max-image-preview:large" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="canonical" href="https://www.jsonbeautifierpro.com/contrato-habitacion.html" />
<link rel="icon" href="logo.svg" type="image/svg+xml">

<meta property="og:title" content="Contrato de Habitación en Alquiler | PDF estilo notaría (España)">
<meta property="og:description" content="Genera un contrato de habitación legal en PDF. Vista previa protegida y descarga por 1 € (pago seguro).">
<meta property="og:url" content="https://www.jsonbeautifierpro.com/contrato-habitacion.html">
<meta property="og:type" content="website">
<meta property="og:image" content="https://www.jsonbeautifierpro.com/logo.svg">
<meta property="og:locale" content="es_ES">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Contrato de Habitación PRO (PDF)">
<meta name="twitter:description" content="Rellena online, vista previa y descarga por 1 € (PayPal).">
<meta name="twitter:image" content="https://www.jsonbeautifierpro.com/logo.svg">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Manrope:wght@700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
  :root{ --bg:#f6f8fc; --fg:#0f172a; --muted:#5b6a8a; --panel:#fff; --border:#dfe3f4; --brand:#0ea5e9; --accent:#6366f1; --ok:#22c55e; --danger:#ef4444; --radius:18px; --radius-sm:12px }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  a{color:#1f2a60;text-decoration:none}
  .container{max-width:1200px;margin:0 auto;padding:0 16px}

  .main-header{position:sticky;top:0;z-index:70;background:linear-gradient(180deg,#fff,rgba(255,255,255,.92));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
  .head-wrap{display:grid;grid-template-columns:1fr auto;gap:14px;align-items:center;padding:14px 0}
  .brand{display:flex;align-items:center;gap:12px;min-width:0}
  .brand h1{margin:0;font-family:Manrope,Inter;font-weight:800;letter-spacing:.3px;font-size:clamp(22px,2.8vw,34px);background:linear-gradient(90deg,#0ea5e9,#6366f1 45%,#22c55e);-webkit-background-clip:text;background-clip:text;color:transparent}
  /* Increased header logo size */
  .logo{height:45px;width:140px}

  /* Styling for the split generator title */
  .generator-title{
    display:flex;flex-wrap:wrap;gap:6px;align-items:baseline;
    font-family:Manrope,Inter;font-weight:900;letter-spacing:.3px;
    font-size:clamp(22px,2.8vw,34px);
    color:var(--fg);
    background:none !important;
    -webkit-background-clip:border-box;background-clip:border-box;
  }
  .generator-title .primary{
    background:linear-gradient(90deg,#0ea5e9,#6366f1 45%,#22c55e);
    -webkit-background-clip:text;background-clip:text;
    color:transparent;
  }
  .generator-title .badge{
    font-size:12px;font-weight:800;padding:.35rem .6rem;
    border-radius:999px;border:2px solid var(--accent);
    color:var(--accent);
  }
  .brand .generator-title{
    white-space:normal !important;
    overflow:visible !important;
    text-overflow:clip !important;
    color:var(--fg) !important;
  }
  .cta{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
  .cta p{margin:0;font-size:13px;color:#64748b}
/* Chips del header: que envuelvan y no se corten */
.main-header .trust{
  display:flex; flex-wrap:wrap; gap:6px 8px; align-items:center; max-width:100%;
}
.main-header .trust .chip{
  display:inline-flex; align-items:center; gap:6px;
  padding:.35rem .7rem; border:1px solid #cfd7e6; border-radius:999px;
  background:#f8fafc; font-weight:800; color:#334155; line-height:1;
}
  .btn{display:inline-flex;align-items:center;gap:.6rem;border:1px solid #cfd7e6;background:#fff;border-radius:999px;padding:.7rem 1rem;font-weight:800;cursor:pointer;font-size:14px;box-shadow:0 12px 30px rgba(23,30,70,.08);min-height:44px}
  .btn-primary{background:linear-gradient(90deg,#0ea5e9,#6366f1);border:none;color:#fff}
  .btn-ghost{background:#fff}
  .btn-pay{background:#0070ba;color:#fff;border:none}

  main{padding:26px 0}
  .hero{background:#fff;border:1px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:0 12px 30px rgba(23,30,70,.08);position:relative;overflow:hidden}
  .hero::after{content:"";position:absolute;inset:auto -10% -1px -10%;height:10px;background:linear-gradient(90deg,#22c55e,#6366f1,#0ea5e9);opacity:.18;filter:blur(1px)}
  .hero h2{margin:.4rem 0 .2rem;font-family:Manrope,Inter;font-weight:900;font-size:clamp(20px,2.6vw,30px)}
  .sub{color:#334155;margin:0 0 12px;font-size:15px;font-weight:700}

  .wizard{
   margin-top:16px;
   scroll-margin-top:84px; /* ajusta 72–96px según altura real del header */
   background:#fff;border:1px solid var(--border);border-radius:var(--radius);
   overflow:hidden;box-shadow:0 12px 30px rgba(23,30,70,.08)
 }
  .steps{display:flex}
  .step{flex:1;padding:12px 8px;text-align:center;background:#f3f6ff;border-right:1px solid var(--border);font-weight:800;color:#3b4780}
  .step:last-child{border-right:none}
  .step.active{background:#fff;color:#1e2a60}
  .step .n{display:inline-flex;width:26px;height:26px;align-items:center;justify-content:center;border-radius:999px;border:2px solid #9db4ff;margin-right:6px;font-size:12px}
  .step.active .n{border-color:#4c6fff;background:#4c6fff;color:#fff}
  .progress{height:8px;background:#eef2ff}
  .bar{height:8px;width:0;background:linear-gradient(90deg,#0ea5e9,#6366f1);transition:width .25s}

  .wizard-body{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px;align-items:stretch}
  @media (max-width:980px){.wizard-body{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;box-shadow:0 12px 30px rgba(23,30,70,.08)}
  .left-col{display:flex;flex-direction:column;min-height:100%}

  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .form-grid.full{grid-template-columns:1fr}
  .form-grid label{display:block;font-size:13.5px;color:#2b324f;font-weight:800}
  .form-grid input,.form-grid select,.form-grid textarea{width:100%;margin-top:6px;padding:.7rem .85rem;border:1px solid #cfd7e6;border-radius:12px;font-size:15px;outline:none}
  .form-grid textarea{resize:vertical;min-height:120px}
  .form-grid input:focus,.form-grid select:focus,.form-grid textarea:focus{border-color:#4c6fff;box-shadow:0 0 0 3px #4c6fff25}
  .is-valid{border-color:var(--ok)!important;box-shadow:0 0 0 3px #22c55e22!important}
  .is-invalid{border-color:var(--danger)!important;box-shadow:0 0 0 3px #ef444422!important}
  .err{font-size:12px;color:#ef4444;min-height:16px}

  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px;align-items:center}
  .chip{position:relative;border:1px solid #cfd7e6;background:#f8fafc;border-radius:999px;padding:.45rem .85rem;font-size:12.5px;cursor:pointer;font-weight:800;color:#334155;transition:.15s}
  .chip.active{border-color:#4c6fff;background:linear-gradient(90deg,#0ea5e9,#6366f1);box-shadow:0 6px 16px rgba(80,90,200,.28);color:#fff}
  .chip input[type="checkbox"]{appearance:none;position:absolute;inset:0;opacity:0}

  .search{flex:999 1 420px;min-width:280px;padding:.85rem 1.1rem;border:2px solid #cbd5e1;border-radius:12px;font-size:16px;font-weight:700;color:#0f172a}

  /* Radios “Jurídico/Claro” como Vivienda */
  .seg{display:flex;flex-direction:column;gap:8px;margin-left:auto}
  .seg label{display:flex;align-items:center;gap:8px;border:1px solid #cfd7e6;border-radius:999px;background:#f8fafc;padding:.45rem .85rem;font-weight:800;color:#334155;cursor:pointer;transition:.15s}
  .seg input[type=radio]{appearance:none;width:0;height:0;position:absolute;opacity:0}
  .seg label.active{border-color:#4c6fff;background:linear-gradient(90deg,#0ea5e9,#6366f1);box-shadow:0 6px 16px rgba(80,90,200,.28);color:#fff}

  .clause-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:10px;margin-top:8px}
  @media (min-width:900px){.clause-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (min-width:1200px){.clause-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .clause-card{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;display:flex;gap:10px;align-items:flex-start}
  .clause-card h4{margin:.1rem 0;font-size:14px}
  .clause-card p{margin:0;font-size:12.5px;color:#64748b}
/* Ocultar checkbox interno y resaltar activo (igual que chips) */
label.clause-card{ cursor: pointer; position: relative; }
label.clause-card input[type="checkbox"]{
  appearance: none; position: absolute; inset: 0; opacity: 0;
}
label.clause-card.active{
  border-color:#4c6fff; box-shadow:0 0 0 3px #4c6fff22;
}

  .tag{font-size:11px;border:1px solid #e2e8f0;border-radius:6px;padding:.15rem .4rem;background:#f8fafc;margin-left:6px}

  aside.card{display:flex;flex-direction:column}
  .preview{position:relative;min-height:640px;flex:1;background:#fff;border:1px dashed #d7deee;border-radius:12px;padding:16px;overflow:auto;user-select:none;-webkit-user-select:none}
  .preview::before{content:"VISTA PREVIA PROTEGIDA — JSON BEAUTIFIER PRO";position:absolute;inset:50% auto auto 50%;transform:translate(-50%,-50%) rotate(-22deg);color:#9aa3b51f;font-weight:900;letter-spacing:.06em;font-size:clamp(22px,4vw,38px);pointer-events:none;white-space:nowrap}
  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

  .summary-grid{display:grid;grid-template-columns:1fr;gap:16px}
  .sum-card{border:1px solid #e6ebf4;border-radius:12px;padding:12px;background:#fff}
  .sum-card h4{margin:.2rem 0 .4rem;font-size:14px}
  .sum-line{font-size:13px;color:#334155;margin:.2rem 0}

  .pay-card{border:2px solid #c7d2fe;background:linear-gradient(180deg,#fff,#f7f9ff);border-radius:14px;padding:14px;display:grid;gap:10px}
  .pay-top{display:flex;justify-content:space-between;align-items:center}
  .price{font-family:Manrope,Inter;font-weight:900;font-size:22px}
  .benefits{display:grid;gap:6px;font-size:12.5px;color:#334155}
  .benefits .tick{width:18px;height:18px;border-radius:999px;background:linear-gradient(90deg,#0ea5e9,#6366f1);color:#fff;display:inline-flex;align-items:center;justify-content:center;font-weight:900;font-size:12px;margin-right:6px}

  footer{margin:28px 0 40px;text-align:center;color:#64748b;font-size:13px}
  footer a{margin:0 8px}

  .modal{position:fixed;inset:0;background:#0b1220cc;display:none;align-items:center;justify-content:center;z-index:120}
  .modal.active{display:flex}
  .modal .sheet{background:#fff;border-radius:14px;max-width:940px;max-height:92vh;overflow:auto;padding:18px 20px;border:1px solid var(--border);position:relative;width:min(94vw,940px)}
  .fs-topbar{position:sticky;top:0;display:flex;gap:8px;background:#fff;padding:6px 0;z-index:2}
  .fs-btn{border:1px solid #cbd5e1;background:#fff;border-radius:999px;padding:.45rem .7rem;cursor:pointer;font-weight:900}

  @media (max-width:480px){
  .head-wrap{ grid-template-columns:1fr; }
  .cta{ align-items:flex-start; }
  .search{ min-width:0; flex:999 1 auto; }
  .main-header .trust{ max-width:100%; }
  .main-header .trust .chip{ font-size:12.5px; }
  .brand h1{ white-space: normal; overflow: visible; text-overflow: clip; }
}

/* Toggle "Incluir sello": aspecto de checkbox visible dentro del chip */
#sealToggle{
  display:inline-flex; align-items:center; gap:8px;
  cursor:pointer; user-select:none;
}
#sealToggle .box{
  position:relative; width:18px; height:18px; border:2px solid #cbd5e1;
  border-radius:4px; display:inline-block; flex:0 0 18px; background:#fff;
}
#sealToggle input[type="checkbox"]{
  appearance:none; position:absolute; inset:0; opacity:0;
}
#sealToggle input[type="checkbox"]:focus + .box{
  outline: 2px solid #4c6fff; outline-offset: 2px;
}
#sealToggle input[type="checkbox"]:checked + .box{
  background:#4c6fff; border-color:#4c6fff;
}
#sealToggle input[type="checkbox"]:checked + .box::after{
  content:""; position:absolute; left:5px; top:2px;
  width:4px; height:8px; border-right:2px solid #fff; border-bottom:2px solid #fff;
  transform:rotate(45deg);
}

/* "Pago verificado" como insignia informativa (si la usas en el header de pago) */
#paidSeal{
  cursor:default; pointer-events:none;
  background:#eef2ff; border-color:#cfd7e6; color:#1e293b; box-shadow:none;
}


/* === Paridad móvil con Vivienda + protección de copia === */

/* 1) Formulario a 1 columna en móviles (no apelotonar) */
@media (max-width: 720px){
  .form-grid{ grid-template-columns: 1fr; }
  .seg{ margin-left: 0; }
}
/* CONTRAPEADO en móvil (como Vivienda): #step1 vuelve a 2 columnas */
@media (max-width: 720px){
  #step1.form-grid{ grid-template-columns: 1fr 1fr; }
}

@media (max-width:360px){
  #step1.form-grid{ grid-template-columns: 1fr; }
}


/* 2) Toolbar apilada como en Vivienda (<=400px) */
@media (max-width: 400px){
  .toolbar{ flex-direction: column; align-items: stretch; }
}
/* Altura de la previa en 361–480px (no afecta a <=360px) */
@media (min-width: 361px) and (max-width: 480px){
  .preview{ min-height: 480px; }
}


/* 3) Tweaks finos <=360px (idéntico a Vivienda) */
@media (max-width: 360px){
  .btn{ min-height: 48px; font-size: 15px; padding: .8rem 1.1rem; }
  .search{ font-size: 15px; }
  .preview{ min-height: 420px; } /* Habitación venía con 640px */
}

/* 4) Inputs iOS sin zoom al enfocar */
@media (max-width: 480px){
  .form-grid input, .form-grid select, .form-grid textarea{ font-size: 16px; }
}

/* 5) Cabecera más resiliente en pantallas estrechas */
.brand{ min-width: 0; }
/* Ellipsis solo en ≥481px; en móvil dejamos saltos de línea */
@media (min-width: 481px){
  .brand h1{ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
}


/* 6) Steps con scroll horizontal táctil */
.steps{ overflow-x: auto; -webkit-overflow-scrolling: touch; gap: 0; }
.step{ flex: 0 0 auto; padding: 12px 10px; }

/* 7) Rejilla de cláusulas sin desbordar en 320–360px */
.clause-grid{ grid-template-columns: repeat(auto-fill, minmax(min(100%, 260px), 1fr)); }
.clause-card, .sum-line, .preview p{ overflow-wrap: anywhere; word-break: normal; }
/* Evitar que algún hijo fuerce anchuras raras */
.clause-grid > *{ min-width: 0; }


/* Desktop: columnas fijas para uniformidad */
@media (min-width: 900px){
  .clause-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
}
@media (min-width: 1200px){
  .clause-grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
}

/* 8) Botones de acción cómodos en móvil y modal con safe-area */
@media (max-width: 480px){
  .actions .btn{ width: 100%; }
}
.modal .sheet{ padding-bottom: calc(18px + env(safe-area-inset-bottom)); }

/* 9) Anticopia/antiselección también en fullscreen */
.preview, .preview * , #fsFrame, #fsFrame *{
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
  -webkit-touch-callout: none; /* iOS: sin menú copiar por long-press */
}
#fsFrame{ position: relative; }
#fsFrame::before{
  content: attr(data-watermark);
  position: absolute;
  inset: 50% auto auto 50%;
  transform: translate(-50%, -50%) rotate(-22deg);
  color: #9aa3b51f;
  font-weight: 900;
  letter-spacing: .06em;
  font-size: clamp(22px, 4vw, 38px);
  pointer-events: none;
  white-space: nowrap;
}

/* 10) Mejor tacto (evita retraso de tap) */
button, .chip, .seg label{ touch-action: manipulation; }

  </style>
<!-- SEO: Product + FAQ + Breadcrumbs (Habitación) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Product",
      "@id": "https://www.jsonbeautifierpro.com/contrato-habitacion.html#product",
      "name": "Contrato de arrendamiento de habitación (PDF)",
      "description": "Generador de contrato de habitación estilo notaría: rellena tus datos y descarga el PDF listo para firmar. Incluye inventario opcional.",
      "category": "LegalForms",
      "sku": "contrato-habitacion-pdf",
      "brand": { "@type": "Brand", "name": "JSON Beautifier PRO" },
      "url": "https://www.jsonbeautifierpro.com/contrato-habitacion.html",
      "image": "https://www.jsonbeautifierpro.com/logo.svg",
      "isFamilyFriendly": true,
      "audience": { "@type": "PeopleAudience", "audienceType": "Particulares en España" },
      "offers": {
        "@type": "Offer",
        "priceCurrency": "EUR",
        "price": "1.00",
        "availability": "https://schema.org/InStock",
        "url": "https://www.jsonbeautifierpro.com/contrato-habitacion.html"
      }
    },
    {
      "@type": "FAQPage",
      "@id": "https://www.jsonbeautifierpro.com/contrato-habitacion.html#faq",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "¿Este contrato de habitación está bajo LAU o Código Civil?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Por norma general, el arrendamiento de habitación se rige por el Código Civil (arts. 1542 y ss.), salvo supuestos concretos. En el PDF se indica el marco legal correspondiente."
          }
        },
        {
          "@type": "Question",
          "name": "¿Incluye inventario?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Sí, puedes activar el Anexo I — Inventario. Si lo activas, el PDF añade 'Acceso al inventario' en Condiciones específicas y genera el anexo con los ítems que indiques."
          }
        },
        {
          "@type": "Question",
          "name": "¿Necesito firma electrónica para que sea válido?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. No ofrecemos firma electrónica integrada. Puedes imprimir el PDF y firmarlo manuscrito entre las partes. Si lo preferís, podéis usar una herramienta externa de firma electrónica, pero no forma parte del servicio."
          }
        },
        {
          "@type": "Question",
          "name": "¿Cuánto cuesta y cómo se paga?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Cuesta 1 €. El pago se realiza online y, al completarlo, se desbloquea la descarga del PDF."
          }
        },
        {
          "@type": "Question",
          "name": "¿Qué datos necesito para generarlo?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Dirección, nombres y DNI/NIE de arrendador e inquilino, localidad, duración, fechas de inicio/fin, renta y fianza. Opcionalmente, zonas/servicios incluidos y un inventario."
          }
        }
      ]
    },
    {
      "@type": "BreadcrumbList",
      "@id": "https://www.jsonbeautifierpro.com/contrato-habitacion.html#breadcrumb",
      "itemListElement": [
        { "@type": "ListItem", "position": 1, "name": "Inicio", "item": "https://www.jsonbeautifierpro.com/" },
        { "@type": "ListItem", "position": 2, "name": "Generadores", "item": "https://www.jsonbeautifierpro.com/modelo-contrato-alquiler.html" },
        { "@type": "ListItem", "position": 3, "name": "Contrato de habitación", "item": "https://www.jsonbeautifierpro.com/contrato-habitacion.html" }
      ]
    }
  ]
}
</script>
</head>
<body>
  <header class="main-header">
    <div class="container head-wrap">
      <div class="brand">
        <img class="logo" src="og-contrato-habitacion.png" alt="Logo Generador contrato habitación" width="140" height="45" />
        <h1 class="generator-title">Contrato de <span class="primary">Habitación</span> <span class="badge">PRO</span></h1>
      </div>
      <div class="cta">
        <p>¿Necesitas un contrato de vivienda?</p>
        <button class="btn btn-primary" type="button" onclick="location.href='contrato-alquiler.html'"><i class="fa-solid fa-house"></i> Ir a contrato de vivienda</button>
        <div class="trust" style="margin-top:8px">
          <span class="chip"><i class="fa-solid fa-shield-halved" aria-hidden="true"></i> Pago seguro</span>
          <span class="chip"><i class="fa-solid fa-brain" aria-hidden="true"></i> Todo en tu navegador</span>
          <span class="chip"><i class="fa-solid fa-file-signature" aria-hidden="true"></i> PDF estilo notaría</span>
        </div>
      </div>
    </div>
  </header>

  <main>
    <div class="container hero">
      <h2>Generador de contrato de alquiler de habitación</h2>
      <p class="sub">Crea un contrato profesional en minutos: datos guiados, packs de cláusulas editables, anexos opcionales y descarga en PDF lista para firmar por 1 €.</p>

      <div class="wizard" role="region" aria-label="Generador de contrato">
        <div class="steps" aria-label="Pasos">
          <div class="step active" data-step="1" aria-current="step"><span class="n">1</span>Datos</div>
          <div class="step" data-step="2"><span class="n">2</span>Cláusulas</div>
          <div class="step" data-step="3"><span class="n">3</span>Resumen y pago</div>
        </div>
        <div class="progress" aria-hidden="true"><div class="bar" style="width:0%"></div></div>

        <div class="wizard-body">
          <section class="card left-col">
            <div class="toolbar">
              <button class="btn btn-ghost" id="btnClear" type="button">Limpiar</button>
              <label class="chip" id="chipPersist"><input type="checkbox" id="persistToggle" checked> Guardar datos en tu navegador</label>
            </div>

            <form id="contratoForm" novalidate autocomplete="on" style="flex:1">
              <!-- PASO 1 -->
              <div id="step1" class="form-grid" aria-labelledby="s1">
                <h3 id="s1" style="grid-column:1/-1;margin:.2rem 0">Datos del contrato</h3>

                <label>Dirección completa
                  <input id="direccion" required autocomplete="street-address" aria-describedby="e-dir" />
                </label><div></div><div id="e-dir" class="err" aria-live="polite"></div>

                <label>Nombre del arrendador
                  <input id="arrendador" required autocomplete="name" aria-describedby="e-arr" />
                </label>
                <label>DNI/NIE del arrendador
                  <input id="dniArrendador" required inputmode="text" aria-describedby="e-dna" />
                </label>
                <div id="e-arr" class="err"></div><div id="e-dna" class="err"></div>

                <label>Nombre del inquilino
                  <input id="inquilino" required autocomplete="name" aria-describedby="e-inq" />
                </label>
                <label>DNI/NIE del inquilino
                  <input id="dniInquilino" required inputmode="text" aria-describedby="e-dni" />
                </label>
                <div id="e-inq" class="err"></div><div id="e-dni" class="err"></div>

                <label>Localidad
                  <input id="localidad" required autocomplete="address-level2" aria-describedby="e-loc" />
                </label>
                <label>Duración (meses)
                  <input id="duracion" type="number" min="1" required aria-describedby="e-dur" />
                </label>
                <div id="e-loc" class="err"></div><div id="e-dur" class="err"></div>
		<!-- Identificación de la habitación (contrapeado como Vivienda) -->
<label>Identificador / Nº habitación
  <input id="habId" type="text" placeholder="Ej.: Hab. 3 / 3B">
</label>
<label>Planta / Puerta
  <input id="habPlanta" type="text" placeholder="Ej.: 2ª — B">
</label>
<div class="err"></div><div class="err"></div>

<label>Superficie habitación (m²)
  <input id="habM2" type="number" step="0.1" min="0" placeholder="Ej.: 10.5">
</label>
<label>¿Amueblada?
  <select id="habAmueblada">
    <option value="">—</option>
    <option value="si">Sí</option>
    <option value="no">No</option>
  </select>
</label>
<div class="err"></div><div class="err"></div>

<label style="grid-column:1/-1">Descripción breve
  <textarea id="habDescripcion" rows="2" placeholder="Ej.: Cama 135, armario de 2 puertas, mesa y silla."></textarea>
</label>
                <label>Fecha de inicio
                  <input id="fechaInicio" type="date" required aria-describedby="e-fi" />
                </label>
                <label>Fecha de fin
                  <input id="fechaFin" type="date" required aria-describedby="e-ff" />
                </label>
                <div id="e-fi" class="err"></div><div id="e-ff" class="err"></div>

                <label>Precio mensual (€)
                  <input id="renta" type="number" min="0" step="0.01" required aria-describedby="e-renta" />
                </label>
                <label>Fianza (€)
                  <input id="fianza" type="number" min="0" step="0.01" required aria-describedby="e-fianza" />
                </label>
                <div id="e-renta" class="err"></div><div id="e-fianza" class="err"></div>

                <!-- Zonas comunes y suministros -->
                <div class="form-grid full" style="grid-column:1/-1">
                  <div class="card" style="padding:12px">
                    <h4 style="margin:.2rem 0 .6rem">Zonas comunes incluidas</h4>
                    <div class="toolbar" id="zonasChips">
                      <label class="chip"><input type="checkbox" name="zc" value="Cocina"> Cocina</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Salón"> Salón</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Baño"> Baño</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Terraza"> Terraza</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Lavadero"> Lavadero</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Trastero"> Trastero</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Garaje"> Garaje</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Piscina"> Piscina</label>
                      <label class="chip"><input type="checkbox" name="zc" value="Gimnasio"> Gimnasio</label>
                    </div>

                    <div class="form-grid" style="margin-top:12px">
                      <label>Wi-Fi incluido
                        <select id="wifi"><option value="no">No</option><option value="si">Sí</option></select>
                      </label>
                      <label>¿Se permite fumar?
                        <select id="fumar"><option value="no">No</option><option value="si">Sí</option></select>
                      </label>

                      <label style="grid-column:1/-1">Suministros incluidos (marca los que incluye la renta)</label>
                      <div class="toolbar" id="sumiChips" style="grid-column:1/-1">
                        <label class="chip"><input type="checkbox" id="incAgua" value="Agua"> Agua</label>
                        <label class="chip"><input type="checkbox" id="incLuz"  value="Luz"> Luz</label>
                        <label class="chip"><input type="checkbox" id="incGas"  value="Gas"> Gas</label>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- /Zonas comunes y suministros -->
              </div>

              <!-- PASO 2 -->
              <div id="step2" class="form-grid full" style="display:none" aria-labelledby="s2">
                <h3 id="s2" style="margin:.2rem 0">Cláusulas y anexos</h3>
                <div>
                  <div class="toolbar">
                    <input type="search" id="clauseSearch" class="search" placeholder="Buscar cláusulas (ruidos, llaves, obras, mascotas…)" />

                    <button type="button" class="chip" data-preset="obligatorias">Obligatorias</button>
                    <button type="button" class="chip" data-preset="estandar">Estándar</button>
                    <button type="button" class="chip" data-preset="proteccion">Protección extra</button>
                    <button type="button" class="chip" data-preset="premium">Pack Premium</button>

                    <label class="chip" id="chipInv"><input type="checkbox" id="anexoInventario" /> Anexo I: Inventario (opcional)</label>

                    <div class="seg" id="langSeg" role="group" aria-label="Modo de lenguaje">
                      <label for="langJ"><input type="radio" name="lang" id="langJ" value="juridico" checked> Jurídico</label>
                      <label for="langC"><input type="radio" name="lang" id="langC" value="claro"> Claro</label>
                    </div>

                    <span id="clauseCount" style="font-weight:800;color:#334155">0 cláusulas extra</span>
                  </div>

                  <div id="mandatoryList" class="clause-grid" aria-label="Cláusulas obligatorias"></div>
                  <div id="clauseList" class="clause-grid" aria-label="Cláusulas opcionales"></div>

                  <div id="anexosBox" class="card" style="display:none;margin-top:10px">
                    <h4 style="margin:.2rem 0 8px">Anexos</h4>
                    <div id="anexoInvBox" style="display:none;margin-bottom:8px">
                      <b>Anexo I — Inventario</b>
                      <p style="margin:.4rem 0;color:#64748b">Escribe cada línea como <i>Elemento | Estado | Observaciones</i> o separa con <code>|</code>, <code>;</code>, <code>/</code>, <code>-</code>, <code>—</code>, coma o tabulador.</p>
                      <div class="form-grid full">
                        <label>Inventario (uno por línea)
                          <textarea id="inventarioTxt" placeholder="Sofá | Bueno | Sin rozaduras&#10;Cama / Muy bueno / Colchón 1,35"></textarea>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

                           <!-- PASO 3 -->
              <div id="step3" class="form-grid full" style="display:none" aria-labelledby="s3">
                <h3 id="s3" style="margin:.2rem 0">Resumen y pago</h3>
                <div class="summary-grid">
                  <div id="resumenBox" class="sum-card" aria-live="polite"></div>
                  <div class="pay-card" id="payCard">
                    <div class="pay-top">
                      <div>
                        <div style="font-weight:900">Descarga PDF estilo notaría</div>
                        <div style="font-size:12.5px;color:#334155">Se habilita al confirmar el pago</div>
                      </div>
                      <div class="price">1 €</div>
                    </div>
                    <div class="benefits">
                      <div><span class="tick">✓</span> Sello “Pago verificado”</div>
                      <div><span class="tick">✓</span> Sin registros ni subir datos</div>
                      <div><span class="tick">✓</span> Guardado local opcional</div>
                    </div>

  <!-- Botón PayPal NCP exclusivo de HABITACIÓN -->

<style>
  .pp-FQE2RL234MT9C {
    text-align:center;border:none;border-radius:0.25rem;min-width:11.625rem;
    padding:0 2rem;height:2.625rem;font-weight:bold;background:#FFD140;color:#000;
    font-family:"Helvetica Neue",Arial,sans-serif;font-size:1rem;line-height:1.25rem;cursor:pointer;
  }
</style>

<div class="ppNcpWrap" style="margin-top:1rem;display:inline-grid;justify-items:center;gap:.5rem">
  <!-- Botón visible que ENVÍA el form oculto #ppNcpForm -->
  <button class="pp-FQE2RL234MT9C" type="submit" form="ppNcpForm" formnovalidate>Comprar ahora</button>

  <img src="https://www.paypalobjects.com/images/Debit_Credit_APM.svg" alt="cards" />
  <section style="font-size:.75rem;">
    Tecnología de
    <img src="https://www.paypalobjects.com/paypal-ui/logos/svg/paypal-wordmark-color.svg"
         alt="paypal" style="height:.875rem;vertical-align:middle;"/>
  </section>
</div>

<div class="actions" id="payActions" style="align-items:center; gap:10px; margin-top:8px;">
  <button type="button" class="btn btn-primary" id="btnDownload" style="display:none">
    <i class="fa-solid fa-file-pdf" aria-hidden="true"></i> Descargar PDF
  </button>

  <!-- Opcional: toggle del sello “Pago verificado” (tu JS ya lo soporta) -->
 <div id="sealWrap" style="display:none">
  <label id="sealToggle" class="chip">
    <input type="checkbox" id="sealOpt" role="switch" />
    <span class="box"></span>
    <span class="txt">Incluir sello “Pago verificado” en el PDF</span>
  </label>
</div>

</div>


<p id="payError" class="err" aria-live="polite"></p>
<p style="font-size:12px;color:#475569;margin-top:6px">
  Producto digital. No admite devoluciones (art. 103.m TRLGDCU).
</p>


                  </div>
                </div>
              </div>

              <!-- Navegación -->
              <div class="actions">
                <button type="button" class="btn btn-ghost" id="btnPrev" disabled>← Atrás</button>
                <div style="flex:1"></div>
                <button type="button" class="btn btn-primary" id="btnNext">Siguiente →</button>
              </div>
            </form>
          </section>

          <aside class="card">
            <h3 style="margin:0 0 8px 0;">Vista previa protegida</h3>
            <div class="preview" id="vistaContrato" aria-label="Vista previa (no copiable)"></div>
            <div class="actions"><button class="btn" type="button" id="btnFullSide">Pantalla completa</button></div>
            <div style="margin-top:6px"><meter id="meter" min="0" max="100" value="0"></meter> <b id="pct">0 % completado</b></div>
          </aside>
        </div>
      </div>
    </div>

    <section id="faq-habitacion" class="container" style="max-width:820px;margin:28px auto">
      <h2 class="text-xl" style="font-weight:800;margin:.2rem 0 12px">Preguntas frecuentes</h2>

      <details class="mb-3" open>
        <summary class="font-medium">¿Este contrato de habitación está bajo LAU o Código Civil?</summary>
        <div class="mt-2 text-sm" style="line-height:1.65">
          Por norma general, el arrendamiento de habitación se rige por el <em>Código Civil</em> (arts. 1542 y ss.), salvo supuestos concretos. En el PDF se indica el marco legal correspondiente.
        </div>
      </details>

      <details class="mb-3">
        <summary class="font-medium">¿Incluye inventario?</summary>
        <div class="mt-2 text-sm" style="line-height:1.65">
          Sí, puedes activar el <strong>Anexo I — Inventario</strong>. Si lo activas, el PDF añade “Acceso al inventario” en Condiciones específicas y genera el anexo con los ítems que indiques.
        </div>
      </details>

      <details class="mb-3">
        <summary class="font-medium">¿Necesito firma electrónica para que sea válido?</summary>
        <div class="mt-2 text-sm" style="line-height:1.65">
          <strong>No</strong>. No ofrecemos firma electrónica integrada. Puedes imprimir el PDF y firmarlo manuscrito entre las partes. Si lo preferís, podéis usar una herramienta externa de firma electrónica, pero no forma parte del servicio.
        </div>
      </details>

      <details class="mb-3">
        <summary class="font-medium">¿Cuánto cuesta y cómo se paga?</summary>
        <div class="mt-2 text-sm" style="line-height:1.65">
          Cuesta <strong>1 €</strong>. El pago se realiza online y, al completarlo, se desbloquea la descarga del PDF.
        </div>
      </details>

      <details class="mb-3">
        <summary class="font-medium">¿Qué datos necesito para generarlo?</summary>
        <div class="mt-2 text-sm" style="line-height:1.65">
          Dirección, nombres y DNI/NIE de arrendador e inquilino, localidad, duración, fechas de inicio/fin, renta y fianza. Opcionalmente, zonas/servicios incluidos y un inventario.
        </div>
      </details>
    </section>

  </main>

  <footer class="container">
  <div>
    <a href="aviso-legal.html?from=habitacion">Aviso legal</a> •
    <a href="privacidad-contrato.html?from=habitacion">Privacidad</a> •
    <a href="cookies.html?from=habitacion">Cookies</a> •
    <a href="contacto.html?from=habitacion">Contacto</a>
  </div>
  <div style="margin-top:6px">JSON Beautifier PRO © 2025</div>
</footer>


  <!-- Modal fullscreen -->
  <div class="modal" id="fs">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Vista previa a pantalla completa">
      <div class="fs-topbar">
        <button class="fs-btn" id="zoomOut" type="button">−</button>
        <button class="fs-btn" id="zoomIn"  type="button">＋</button>
        <button class="fs-btn" id="fsClose" type="button">✕</button>
      </div>
      <div id="fsFrame" data-watermark="VISTA PREVIA PROTEGIDA — JSON BEAUTIFIER PRO"></div>
    </div>
  </div>

  <!-- === PARTE 2/3 — SCRIPT UI (validación, vista previa, presets, navegación, pago) === -->
  <script>
  // ---------- Helpers DOM ----------
  const $   = (id)=>document.getElementById(id);
  const qsa = (sel)=> Array.from(document.querySelectorAll(sel));

  // ---------- Estado ----------
  window.LSKEY  = window.LSKEY  || "contrato_habitacion_v2";
window.STEP_K = window.STEP_K || "HAB_STEP";
window.refreshPayUI = window.refreshPayUI || function(){};
const PRESET_K = LSKEY + "_preset";
window.PRESET_K = PRESET_K;
let __downloading = false;
  let currentStep = Number(localStorage.getItem(STEP_K) || "1");
window.currentStep = currentStep;
  window.hasPaid  = localStorage.getItem("HAB_PAID") === "1";   // controla visibilidad botón descarga
  window.orderId  = localStorage.getItem("HAB_ORDER") || "";
  window.langMode = localStorage.getItem(LSKEY+"_lang") || "juridico"; // 'juridico' | 'claro'

  // ---------- Cláusulas ----------
  const CLAUSES_MANDATORY = [
    {id:"objeto",   title:"Objeto y partes", J:"El arrendador cede al arrendatario el uso de una habitación en la vivienda indicada, junto con el uso de las zonas comunes acordadas.", C:"El propietario cede una habitación al inquilino y el uso de las zonas comunes pactadas."},
    {id:"duracion", title:"Duración",        J:"El arrendamiento tendrá la duración establecida en el formulario y se prorrogará conforme a la normativa vigente salvo pacto en contrario.", C:"El contrato dura lo indicado; después puede prorrogarse según la ley."},
    {id:"precio",   title:"Precio y fianza", J:"La renta mensual y la fianza se fijan según el formulario. El impago faculta la resolución del contrato.", C:"La renta y la fianza son las que has indicado. Si no se paga, el contrato puede resolverse."}
  ];
  const CLAUSES_EXTRA = [
  {id:"zonas",  title:"Zonas comunes",
   J:"El arrendatario tendrá derecho a usar las zonas comunes señaladas, respetando su correcta utilización.",
   C:"Puedes usar las zonas comunes marcadas, con buen uso."},
  {id:"llaves", title:"Llaves y accesos",
   J:"Se entregan las llaves necesarias. Su pérdida conlleva el coste de reposición y podrá exigirse un cargo por duplicado.",
   C:"Se entregan llaves; si se pierden, se paga la copia."},
    {id:"ruidos",       title:"Ruidos y convivencia",        J:"El arrendatario evitará actividades molestas, insalubres o ilícitas y observará las normas de la comunidad.", C:"Nada de ruidos ni actividades molestas o ilegales. Cumple las normas de la comunidad."},
    {id:"visitas",      title:"Visitas y pernoctas",         J:"Las visitas serán razonables. Las pernoctas prolongadas requerirán autorización expresa del arrendador.", C:"Visitas sí; pernoctas largas, solo con autorización."},
    {id:"mascotas",     title:"Mascotas",                    J:"Se prohíbe la tenencia de animales salvo autorización escrita del arrendador. En caso de autorización, el arrendatario responderá de daños y limpieza.", C:"No se permiten mascotas salvo permiso por escrito; si las hay, respondes de daños y limpieza."},
    {id:"obras",        title:"Obras y modificaciones",      J:"Queda prohibida la realización de obras o modificaciones sin consentimiento por escrito del arrendador.", C:"No hagas obras ni cambios sin permiso por escrito."},
    {id:"limpieza",     title:"Limpieza y mantenimiento",    J:"El arrendatario mantendrá la habitación y zonas comunes en correcto estado de limpieza, retirando residuos y colaborando en turnos si existieran.", C:"Mantén limpia tu habitación y ayuda en la limpieza de zonas comunes."},
    {id:"reparaciones", title:"Reparaciones y averías",      J:"Las pequeñas reparaciones derivadas del uso ordinario serán a cargo del arrendatario; las estructurales o por vicios ocultos, del arrendador.", C:"Las pequeñas reparaciones por uso normal las pagas tú; las grandes o de estructura, el propietario."},
    {id:"paqueteria",   title:"Correspondencia y paquetería",J:"El arrendador no será responsable de la pérdida o deterioro de envíos. El arrendatario autoriza la recepción en portería o vecinos cuando sea preciso.", C:"No nos hacemos responsables de paquetes perdidos; autorizas recepción en portería o vecinos si hace falta."}
  ];
  const getClauseText = (c) => (window.langMode==="claro" ? (c.C || c.J) : c.J);
// PUBLICA en window (antes de que corra la “biblioteca reforzada”)
// (no sembramos aquí; la versión final la establece el script reforzado)
window.CLAUSES_EXTRA     = (window.CLAUSES_EXTRA     || []).concat(CLAUSES_EXTRA);

  // Preset por defecto (3 extras)
  window.selectedClauses = new Set(["zonas","llaves","ruidos"]);
  let selectedPreset = "estandar";

  // ---------- Render cláusulas ----------
  function renderMandatory(){
  const MAND = window.CLAUSES_MANDATORY || CLAUSES_MANDATORY;
  const html = MAND.map(c=>`
    <div class="clause-card">
      <input type="checkbox" checked disabled>
      <div><h4>✔ ${c.title} <span class="tag">obligatoria</span></h4><p>${getClauseText(c)}</p></div>
    </div>`).join("");
  const box = $("mandatoryList"); if (box) box.innerHTML = html;
}

function renderClausePicker(filter=""){
  const EXTRA = window.CLAUSES_EXTRA || CLAUSES_EXTRA;
  const norm = (s)=> (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  const t = norm(filter);
  const html = EXTRA
    .filter(c => !t || norm(c.title+getClauseText(c)).includes(t))
    .map(c=>`
      <label class="clause-card">
        <input type="checkbox" ${window.selectedClauses.has(c.id)?'checked':''} data-id="${c.id}">
        <div><h4>${c.title}</h4><p>${getClauseText(c)}</p></div>
      </label>`).join("");
  const box = $("clauseList"); if (box) box.innerHTML = html;

  qsa('#clauseList label.clause-card input[type="checkbox"]').forEach(cb=>{
    const lbl = cb.closest('label.clause-card');
    const sync=()=> lbl && lbl.classList.toggle('active', cb.checked);
    sync();
    cb.addEventListener('change', e=>{
      const id = e.target.getAttribute('data-id');
      if (e.target.checked) window.selectedClauses.add(id);
      else window.selectedClauses.delete(id);
      updateClauseCount(); actualizarVista(); saveState();
      sync();
    });
  });
}

  function updateClauseCount(){
    const n = window.selectedClauses.size;
    const el = $("clauseCount");
    if (el) el.textContent = `${n} cláusula${n===1?"":"s"} extra`;
  }
  

  // ---------- Zonas/servicios ----------
  function wireChipGroup(sel){
    qsa(sel+' input[type="checkbox"]').forEach(chk=>{
      const lab = chk.closest("label.chip");
      const sync=()=> lab && lab.classList.toggle("active", chk.checked);
      sync();
      chk.addEventListener("change", ()=>{ sync(); actualizarVista(); saveState(); });
    });
  }
  function getZonas(){ return qsa('input[name="zc"]').filter(e=>e.checked).map(e=>e.value); }
  function getServiciosIncluidos(){
    const arr=[]; if ($("incAgua")?.checked) arr.push("Agua");
    if ($("incLuz")?.checked) arr.push("Luz");
    if ($("incGas")?.checked) arr.push("Gas");
    if (( $("wifi")?.value||"no")==="si") arr.push("Wi-Fi");
    return arr;
  }

  // ---------- Resumen + Vista protegida ----------
  const fmtFecha = (v) => !v ? "—" : new Date(v+"T00:00:00").toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"});
  function resumenHTML(){
    const g=id=>($(id)?.value||""); const N=v=>(v||"").toUpperCase().replace(/\s+/g,"");
    const zonas = getZonas(), serv=getServiciosIncluidos();
    const fumar = (( $("fumar")?.value)||"no")==="si" ? "Permitido" : "No permitido";
    const anex = $("anexoInventario")?.checked ? "Inventario" : "—";
    return `
      <div class="sum-card"><h4>Partes</h4>
        <div class="sum-line"><b>Arrendador:</b> ${g("arrendador")} · ${N(g("dniArrendador"))}</div>
        <div class="sum-line"><b>Inquilino:</b> ${g("inquilino")} · ${N(g("dniInquilino"))}</div>
      </div>
      <div class="sum-card"><h4>Inmueble</h4>
        <div class="sum-line">${g("direccion")||"—"}</div>
        <div class="sum-line">${g("localidad")||"—"}</div>
      </div>
      <div class="sum-card"><h4>Condiciones</h4>
        <div class="sum-line">Duración: <b>${g("duracion")||"—"}</b> meses</div>
        <div class="sum-line">Fechas: ${fmtFecha(g("fechaInicio"))} - ${fmtFecha(g("fechaFin"))}</div>
        <div class="sum-line">Fumar: ${fumar}</div>
      </div>
      <div class="sum-card"><h4>Importes</h4>
        <div class="sum-line">Precio mensual: <b>${g("renta")||"—"} €</b></div>
        <div class="sum-line">Fianza: <b>${g("fianza")||"—"} €</b></div>
      </div>
      <div class="sum-card"><h4>Zonas y servicios</h4>
        <div class="sum-line"><b>Zonas comunes:</b> ${zonas.length? zonas.join(", ") : "—"}</div>
        <div class="sum-line"><b>Servicios incluidos:</b> ${serv.length? serv.join(", ") : "—"}</div>
      </div>
      <div class="sum-card"><h4>Anexos</h4>
        <div class="sum-line">${anex}</div>
      </div>`;
  }
  function construirClausulas(){
  const base   = (window.CLAUSES_MANDATORY && window.CLAUSES_MANDATORY.length) ? window.CLAUSES_MANDATORY : (typeof CLAUSES_MANDATORY!=="undefined" ? CLAUSES_MANDATORY : []);
  const extras = (window.CLAUSES_EXTRA && window.CLAUSES_EXTRA.length) ? window.CLAUSES_EXTRA : (typeof CLAUSES_EXTRA!=="undefined" ? CLAUSES_EXTRA : []);
  const blocks=[];
  base.forEach(c => blocks.push({title:c.title, text:getClauseText(c)}));
  const map = new Map(extras.map(c=>[c.id,c]));
  (window.selectedClauses ? Array.from(window.selectedClauses) : []).forEach(id=>{
    const c = map.get(id); if (c) blocks.push({title:c.title, text:getClauseText(c)});
  });
  return blocks;
}

function vistaHTML(){
  const g = id => (document.getElementById(id)?.value || "");
  const N = s => String(s || "").toUpperCase().replace(/\s+/g, "");
  const esc = s => String(s ?? "")
    .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  const fmtFecha = (v) => !v
    ? "—"
    : new Date(v + "T00:00:00").toLocaleDateString("es-ES", { day:"numeric", month:"long", year:"numeric" });

  const zonas = (typeof getZonas === "function" ? getZonas() : []);
  const serv  = (typeof getServiciosIncluidos === "function" ? getServiciosIncluidos() : []);
  const fumar = ((document.getElementById("fumar")?.value) || "no") === "si" ? "Permitido" : "No permitido";

  let h = "";

  // Partes
  h += `<p><strong>Arrendador:</strong> ${esc(g("arrendador"))} · ${N(g("dniArrendador"))}</p>`;
  h += `<p><strong>Inquilino:</strong> ${esc(g("inquilino"))} · ${N(g("dniInquilino"))}</p>`;

  // Inmueble / Duración
  h += `<p><strong>Dirección:</strong> ${esc(g("direccion"))}</p>`;
  h += `<p><strong>Localidad:</strong> ${esc(g("localidad"))} — <strong>Duración:</strong> ${esc(g("duracion") || "—")} meses</p>`;
  h += `<p><strong>Fechas:</strong> ${fmtFecha(g("fechaInicio"))} – ${fmtFecha(g("fechaFin"))}</p>`;

  // Importes
  h += `<p><strong>Precio mensual:</strong> ${esc(g("renta") || "—")} € · <strong>Fianza:</strong> ${esc(g("fianza") || "—")} €</p>`;

  // Datos específicos de la habitación
  const am = document.getElementById("habAmueblada")?.value;
  const amTxt = am === "si" ? "Amueblada" : (am === "no" ? "Sin amueblar" : "—");
  h += `<p><strong>Habitación:</strong> ${esc(g("habId") || "—")} · ${esc(g("habPlanta") || "—")} · ${esc(g("habM2") || "—")} m² · ${amTxt}</p>`;
  const desc = (g("habDescripcion") || "").trim();
  if (desc) h += `<p><strong>Descripción:</strong> ${esc(desc)}</p>`;

  // Zonas/Servicios
  if (zonas?.length) h += `<p><strong>Zonas comunes:</strong> ${zonas.map(esc).join(", ")}</p>`;
  if (serv?.length)  h += `<p><strong>Incluye:</strong> ${serv.map(esc).join(", ")} · <strong>Wi-Fi:</strong> ${document.getElementById("wifi")?.value==="si"?"Sí":"No"} · <strong>Fumar:</strong> ${fumar}</p>`;

  // Cláusulas adicionales (si existe tu builder)
  if (typeof construirClausulas === "function"){
    const cls = construirClausulas();
    if (Array.isArray(cls) && cls.length){
      h += `<hr><h4>Cláusulas adicionales</h4>`;
      h += cls.map(c => `<p><strong>${esc(c.title)}:</strong> ${esc(c.text)}</p>`).join("");
    }
  }

  // Anexos
  const anexInv = !!document.getElementById("anexoInventario")?.checked;
  if (anexInv){
    h += `<hr><p><strong>Anexos:</strong> Inventario</p>`;
  }

  return h;
}


  function lockPreviewEvents(el){ if (!el || el.dataset.locked) return; ["copy","cut","paste","contextmenu"].forEach(ev => el.addEventListener(ev, e=>e.preventDefault())); el.onselectstart = () => false; el.dataset.locked = "1"; }
// Bloqueo de atajos de copiar/cortar/seleccionar mientras esté abierto el fullscreen
function toggleCopyGuard(on){
  const block = (e)=>{
    if ((e.ctrlKey || e.metaKey) && ["c","x","a","p","s"].includes((e.key||"").toLowerCase())){
      e.preventDefault();
    }
  };
  if (on){
    document.addEventListener('keydown', block, true);
    document._copyGuard = block;
  }else if (document._copyGuard){
    document.removeEventListener('keydown', document._copyGuard, true);
    document._copyGuard = null;
  }
}


  function renderResumen(){ const box=$("resumenBox"); if(box) box.innerHTML = resumenHTML(); }
  function actualizarVista(){
    const v=$("vistaContrato"); if(!v) return;
    v.innerHTML = vistaHTML();
    lockPreviewEvents(v);
    renderResumen();

    // progreso
    const pct = progress();
    if($("meter")) $("meter").value=pct;
    if($("pct"))   $("pct").textContent = pct+" % completado";

    // Visibilidad de descarga: la decide gateDownload() (pago + bind)
if (typeof gateDownload === "function") gateDownload();


    // Sello de pago si existe ensurePaidSeal (PARTE 3)
    if (typeof ensurePaidSeal === "function") ensurePaidSeal();
  }
  window.actualizarVista = actualizarVista; // consola

  // ---------- Validación ----------
  const DNI_LETTERS = "TRWAGMYFPDXBNJZSQVHLCKE";
  const normalizeId = (v) => (v || "").toUpperCase().replace(/\s+/g, "").trim();
  const calcDNILetter = (num) => { const n = Number(num); return Number.isFinite(n) ? DNI_LETTERS[n % 23] : null; };
  function validateDNIorNIE(raw){
    const v = normalizeId(raw);
    if (/^\d{8}[A-Z]$/.test(v)) return calcDNILetter(v.slice(0, 8)) === v.slice(8);
    if (/^[XYZ]\d{7}[A-Z]$/.test(v)) { const n = v.replace(/^X/,"0").replace(/^Y/,"1").replace(/^Z/,"2"); return calcDNILetter(n.slice(0, 8)) === v.slice(-1); }
    return false;
  }
  const requiredIds = ["direccion","arrendador","dniArrendador","inquilino","dniInquilino","localidad","duracion","fechaInicio","fechaFin","renta","fianza"];
  function setErr(id,msg=""){ const map={direccion:"e-dir",arrendador:"e-arr",dniArrendador:"e-dna",inquilino:"e-inq",dniInquilino:"e-dni",localidad:"e-loc",duracion:"e-dur",fechaInicio:"e-fi",fechaFin:"e-ff",renta:"e-renta",fianza:"e-fianza"}; const eid=map[id]; if(eid) $(eid).textContent = msg; }
  function validar(){
    let ok=true; const fi=$("fechaInicio")?.value, ff=$("fechaFin")?.value;
    const check=(id,cond,msg)=>{
      const el=$(id);
      if(!cond){ ok=false; setErr(id,msg||"Revisa este campo."); el?.classList.add("is-invalid"); el?.classList.remove("is-valid"); }
      else     { setErr(id,"");                 el?.classList.remove("is-invalid"); el?.classList.add("is-valid"); }
    };
    check("direccion", !!$("direccion")?.value?.trim());
    check("arrendador", !!$("arrendador")?.value?.trim());
    check("dniArrendador", validateDNIorNIE($("dniArrendador")?.value), "DNI/NIE no válido.");
    check("inquilino", !!$("inquilino")?.value?.trim());
    check("dniInquilino", validateDNIorNIE($("dniInquilino")?.value), "DNI/NIE no válido.");
    check("localidad", !!$("localidad")?.value?.trim());
    check("duracion", Number($("duracion")?.value)>=1, "Mínimo 1 mes.");
    check("fechaInicio", !!fi);
    check("fechaFin", !!ff && new Date(ff)>=new Date(fi), "La fecha fin debe ser posterior.");
    check("renta", Number($("renta")?.value)>=0);
    check("fianza", Number($("fianza")?.value)>=0);
    return ok;
  }
  window.validar = validar; // consola
  function validateField(el){
if (!el) return;
  const t = (el.type || '').toLowerCase();
  if (['submit','button','image','file','reset','radio'].includes(t)) return; 
    if (!el) return; const id=el.id; let ok=true;
    switch(id){
      case "dniArrendador":
      case "dniInquilino":
        el.value=(el.value||"").toUpperCase().replace(/\s+/g,"");
        ok=el.value.length>=9 && validateDNIorNIE(el.value);
        break;
      case "duracion": ok=Number(el.value)>=1; break;
      case "renta":
      case "fianza":  ok=el.value!=="" && Number(el.value)>=0; break;
      case "fechaInicio":
      case "fechaFin": {
        const fi=$("fechaInicio")?.value, ff=$("fechaFin")?.value;
        const pairOk=!!fi && !!ff && new Date(ff)>=new Date(fi);
        ["fechaInicio","fechaFin"].forEach(id2=>{
          $(id2)?.classList.toggle("is-valid", pairOk);
          $(id2)?.classList.toggle("is-invalid", !pairOk);
        });
        setErr("fechaFin", pairOk?"":"La fecha fin debe ser posterior.");
        return;
      }
      default: ok=(el.value||"").trim().length>0;
    }
    el.classList.toggle("is-valid", ok);
    el.classList.toggle("is-invalid", !ok);
    if(ok) setErr(id,"");
  }
  function progress(){
    let n=0; requiredIds.forEach(id=>{ const el=$(id); if(el && (el.type==='number'? el.value!=='' : el.value)) n++; });
    const pct=Math.round(n*100/requiredIds.length);
    const bar=document.querySelector('.bar'); if(bar) bar.style.width=pct+"%";
    return pct;
  }
  window.progress = progress;

  // ---------- Persistencia ----------
  function serialize(){
  const o = {};
  qsa('#contratoForm input, #contratoForm select, #contratoForm textarea').forEach(el=>{
    const id = (el.id || '').trim();
    const t  = (el.type || '').toLowerCase();
    if (!id) return; // ← ignorar elementos sin id (como el submit de PayPal)
    if (['submit','button','image','file','reset','radio'].includes(t)) return;

    if (t === 'checkbox') o[id] = !!el.checked;
    else                  o[id] = el.value || '';
  });

  o._zc   = qsa('input[name="zc"]').map(el=>({value:el.value,checked:el.checked}));
  o.clSel = Array.from(window.selectedClauses);
  const _PK  = (typeof PRESET_K !== "undefined") ? PRESET_K : (LSKEY + "_preset");
  const _det = (typeof window.detectPresetFromSelection === "function")
                 ? window.detectPresetFromSelection(window.selectedClauses || new Set())
                 : "";
  o.preset = localStorage.getItem(_PK) || _det;

  o.anexos = {inventario:$("anexoInventario")?.checked||false,
              inventarioTxt:$("inventarioTxt")?.value||""};
  o.lang = window.langMode;
  return JSON.stringify(o);
}

  function saveState(){ if(!$("persistToggle")?.checked) return; try{ localStorage.setItem(LSKEY, serialize()); localStorage.setItem(LSKEY+"_lang", window.langMode); } catch (e) {} }

  function populate(){
  const raw = localStorage.getItem(LSKEY); if (!raw) return;
  try{
    const o = JSON.parse(raw);
    qsa('#contratoForm input, #contratoForm select, #contratoForm textarea').forEach(el=>{
      const id = (el.id || '').trim();
      const t  = (el.type || '').toLowerCase();
      if (!id) return; // ← no tocar elementos sin id
      if (['submit','button','image','file','reset','radio'].includes(t)) return;

      const v = o[id]; if (v == null) return;
      if (t === 'checkbox') el.checked = !!v; else el.value = v;
    });

    if (Array.isArray(o._zc)){
      qsa('input[name="zc"]').forEach(el=>{
        const f = o._zc.find(z=>z.value===el.value); if(f) el.checked=!!f.checked;
      });
    }

    window.selectedClauses = new Set(Array.isArray(o.clSel)?o.clSel:["zonas","llaves","ruidos"]);
    if (o.preset){
      localStorage.setItem(PRESET_K, o.preset);
      if (typeof window.markPresetChip === "function") window.markPresetChip(o.preset);
    }
    if (o.anexos){
      if ($("anexoInventario")) $("anexoInventario").checked = !!o.anexos.inventario;
      if ($("inventarioTxt"))   $("inventarioTxt").value     = o.anexos.inventarioTxt || "";
    }
    if (o.lang) window.langMode = o.lang;
  }catch(e){}
}


function revalidateAll(){
  qsa('#contratoForm input, #contratoForm select, #contratoForm textarea')
    .forEach(el => validateField(el));
}

  function syncPersistUI(){
    const lab = $("chipPersist"); const cb  = $("persistToggle");
    if (lab && cb) lab.classList.toggle("active", !!cb.checked);
  }

  // ---------- Navegación ----------
  function goStep(n){
    currentStep=Math.max(1,Math.min(3,n));
    window.currentStep = currentStep;
    try { localStorage.setItem(STEP_K,String(currentStep)); } catch (e) {}

    qsa('.step').forEach((s,i)=> s.classList.toggle('active', (i+1)===currentStep));
    $("step1").style.display = currentStep===1? 'grid':'none';
    $("step2").style.display = currentStep===2? 'grid':'none';
    $("step3").style.display = currentStep===3? 'grid':'none';
    $("btnPrev")?.toggleAttribute('disabled', currentStep===1);
    const next=$("btnNext"); if(next) next.style.display = (currentStep===3? 'none' : 'inline-flex');
     actualizarVista();
     if (typeof refreshPayUI === "function") refreshPayUI();


  // Precarga jsPDF al entrar en Paso 3 (mejora UX de "Descargar PDF")
  if (currentStep === 3 && typeof ensurePDFLibs === "function") {
    // no bloquea la UI; si ya estaba cargado, ensurePDFLibs() sale rápido
    Promise.resolve().then(() => ensurePDFLibs()).catch(()=>{});

  }
// Al cambiar de paso, sube al principio del asistente
setTimeout(()=>{
  document.querySelector('.wizard')?.scrollIntoView({ behavior:'smooth', block:'start' });
}, 0);
}

  window.goStep = goStep;

  // ---------- Pantalla completa ----------
  function openFull(){
  const cont = $("fsFrame"); if (!cont) return;
  $("fs").classList.add('active');
  document.body.style.overflow = 'hidden';
  cont.innerHTML = `<div style="padding:18px; transform-origin: top left;">${$("vistaContrato").innerHTML}</div>`;
  cont.firstElementChild.dataset.z = '1';
  lockPreviewEvents(cont);   // protege copia/selección en fullscreen
  toggleCopyGuard(true);     // bloquea Cmd/Ctrl+C/X/A/P/S mientras esté abierto
}
  function closeFull(){
  $("fs").classList.remove('active');
  document.body.style.overflow = '';
  toggleCopyGuard(false);    // restaura atajos
}
  function zoom(delta){ const el=$("fsFrame").firstElementChild; if(!el) return; const cur=Number(el.dataset.z||'1'); const nx=Math.max(.5,Math.min(2.2,cur+delta)); el.style.transform=`scale(${nx})`; el.dataset.z=String(nx); }


  // ---------- Inicio ----------
  document.addEventListener('DOMContentLoaded', ()=>{
    // Preferencia del toggle "Guardar datos"
 populate();           // ← esto rehidrata selección de cláusulas y preset
  actualizarVista();
  renderClausePicker(document.getElementById("clauseSearch")?.value || "");
    const pFlag = localStorage.getItem('HAB_PERSIST'); // '1' o '0'
    if (pFlag === '0') { $("persistToggle").checked = false; }
    if (pFlag === '1') { $("persistToggle").checked = true;  }
    syncPersistUI();

    $("persistToggle")?.addEventListener('change', ()=>{
      syncPersistUI();
      if ($("persistToggle").checked) {
        try { localStorage.setItem('HAB_PERSIST','1'); saveState(); } catch (e) {}
      } else {
        try { localStorage.setItem('HAB_PERSIST','0'); localStorage.removeItem(LSKEY); } catch (e) {}      }
    });

    // Cargar datos guardados y render inicial
    populate();
    revalidateAll();
    renderMandatory(); renderClausePicker(); updateClauseCount();

    // Lang segment
    const lJ= $("langJ"), lC=$("langC");
    const syncLang=()=>{ $("langJ")?.closest("label")?.classList.toggle("active", window.langMode==="juridico"); $("langC")?.closest("label")?.classList.toggle("active", window.langMode==="claro"); };
    if(window.langMode==="claro") { lC.checked = true; } else { lJ.checked = true; }
    lJ?.addEventListener('change', ()=>{ window.langMode='juridico'; renderMandatory(); renderClausePicker($("clauseSearch")?.value||''); actualizarVista(); saveState(); syncLang(); });
    lC?.addEventListener('change', ()=>{ window.langMode='claro';    renderMandatory(); renderClausePicker($("clauseSearch")?.value||''); actualizarVista(); saveState(); syncLang(); });
    syncLang();

    // Mostrar paso actual
    goStep(currentStep||1);
if (window.hasPaid) { goStep(3); }
refreshPayUI();

// === Sincroniza aria-current con el paso activo (accesibilidad) ===
(function setupAriaSteps(){
  const steps = document.querySelectorAll(".steps .step");
  if (!steps.length) return;

  const sync = () => {
    let foundActive = false;
    steps.forEach((el) => {
      const isActive = el.classList.contains("active");
      if (isActive && !foundActive) {
        el.setAttribute("aria-current", "step");
        foundActive = true;
      } else {
        el.removeAttribute("aria-current");
      }
    });
  };

  // Estado inicial (ya con el paso fijado por goStep)
  sync();

  // Observa cambios de clase cuando cambias de paso
  const mo = new MutationObserver(sync);
  steps.forEach(el => mo.observe(el, { attributes: true, attributeFilter: ["class"] }));
})();

    
    // Inputs (validación en vivo + guardado)
    qsa('#contratoForm input, #contratoForm select, #contratoForm textarea').forEach(el=>{
  const t = (el.type || '').toLowerCase();
  if (['submit','button','image','file','reset','radio'].includes(t)) return;

  el.addEventListener('input', ()=>{
    if (t === 'checkbox') return; // ← evita refrescar antes del 'change'
    if(el.id==='dniArrendador' || el.id==='dniInquilino'){
      el.value=(el.value||'').toUpperCase().replace(/\s+/g,'');
    }
    validateField(el); actualizarVista(); saveState();
  });

  el.addEventListener('change', ()=>{
  // 1) Sello: guarda preferencia ANTES de refrescar la UI
  if (el.id === 'sealOpt') {
    localStorage.setItem(LSKEY + "_seal", el.checked ? "1" : "0");
    document.getElementById("sealToggle")?.classList.toggle('active', el.checked);
    refreshPayUI?.();
    return; // ← no dispares ahora el resto de refrescos
  }

  // 2) Inventario: muestra/oculta y luego refresca
  if (el.id === 'anexoInventario'){
    const on = $("anexoInventario")?.checked;
    $("anexosBox").style.display  = on ? "block":"none";
    $("anexoInvBox").style.display = on ? "block":"none";
    $("chipInv")?.classList.toggle("active", !!on);
  }

  // 3) Resto de campos: flujo normal
  actualizarVista(); saveState();
  refreshPayUI?.();
});
});




    // chips zonas/suministros
    wireChipGroup('#zonasChips'); wireChipGroup('#sumiChips');

    // ====== PRESETS: definición + helpers (Habitación) ======
function getPresetSets(){
  return {
    obligatorias: new Set(), // sin extra
    // 6 extras “cotidianas”
    estandar:     new Set(["zonas","llaves","ruidos","visitas","limpieza","reparaciones"]),
    // 10 extras “defensivas”
    proteccion:   new Set(["llaves","ruidos","visitas","limpieza","reparaciones",
                           "acceso","cesion_subarr","penal_posesion","seguro_rc","notifica_email"]),
    // SIEMPRE todo lo disponible
    premium:      new Set((window.CLAUSES_EXTRA||[]).map(c=>c.id))
  };
}
const eqSets = (a,b)=> a.size===b.size && Array.from(a).every(v=>b.has(v));
function detectPresetFromSelection(sel){
  const PS = getPresetSets();
  for (const [id,set] of Object.entries(PS)){ if (eqSets(sel,set)) return id; }
  return "";
}
function markPresetChip(id){
  document.querySelectorAll('.toolbar .chip[data-preset]').forEach(x=>x.classList.remove('active'));
  if (id) document.querySelector(`.toolbar .chip[data-preset="${id}"]`)?.classList.add('active');
}
(function restorePresetChipOnLoad(){
  const PS       = getPresetSets();
  const saved    = localStorage.getItem(PRESET_K) || "";
  const detected = detectPresetFromSelection(window.selectedClauses || new Set());
  const chosen   = saved || detected || "estandar";
  window.selectedClauses = new Set(PS[chosen] || []);
  markPresetChip(chosen);
  localStorage.setItem(PRESET_K, chosen);
  updateClauseCount();
  renderClausePicker(document.getElementById("clauseSearch")?.value || "");
  actualizarVista();
  saveState();
})();

// Click en chips => set dinámico (tu handler ya hace premium dinámico; déjalo igual)


// Click en chips => tomar sets desde getPresetSets()
document.querySelectorAll('.toolbar .chip[data-preset]').forEach(b=> b.addEventListener("click", ()=>{
  const p  = b.dataset.preset;
  const PS = getPresetSets();
  window.selectedClauses = new Set(PS[p] || []);
  localStorage.setItem(PRESET_K, p);
  markPresetChip(p);
  updateClauseCount();
  saveState();
  actualizarVista();
  renderClausePicker(document.getElementById("clauseSearch")?.value || "");
}));


           // navegación
    $("btnPrev")?.addEventListener("click", () => {
      if (typeof goStep === "function") goStep((window.currentStep || 1) - 1);
    });

    // Siguiente: valida en paso 1 y avanza
    document.getElementById("btnNext")?.addEventListener("click", () => {
      if (window.currentStep === 1 && typeof validar === "function" && !validar()) return;
      if (typeof goStep === "function") goStep((window.currentStep || 1) + 1);
    });

    // fullscreen
    $("btnFullSide")?.addEventListener("click", openFull);
    $("fsClose")?.addEventListener("click", closeFull);
    $("zoomIn")?.addEventListener("click", () => zoom(+0.1));
    $("zoomOut")?.addEventListener("click", () => zoom(-0.1));

    // limpiar
    $("btnClear")?.addEventListener("click", () => {
      qsa("#contratoForm input, #contratoForm select, #contratoForm textarea").forEach(el => {
        if (el.type === "checkbox") el.checked = false;
        else if (el.type !== "radio") el.value = "";
        el.classList.remove("is-valid","is-invalid");
      });
      window.selectedClauses = new Set(["zonas","llaves","ruidos"]);
      selectedPreset = "estandar";
      try {
        localStorage.removeItem(LSKEY);
        localStorage.removeItem("HAB_PAID");
        localStorage.removeItem("HAB_ORDER");
        localStorage.setItem(PRESET_K, "estandar");
        localStorage.setItem(STEP_K, "1");
      } catch(e){}
      window.hasPaid = false;
      window.orderId = "";
      actualizarVista();
      saveState();
      renderClausePicker(document.getElementById("clauseSearch")?.value || "");
    });

    // Render final
    actualizarVista();
  }); /* ← cierre ÚNICO del addEventListener('DOMContentLoaded', ...) */
</script>






  <!-- === PDF: INICIO — Bloque “nivel notaría” (líneas solo en 4 cabeceras; sin zebra; sin verticales) === -->
  <script>
  // Silenciar ruido de extensiones
  window.addEventListener('unhandledrejection', ev=>{
    const m = String((ev.reason && ev.reason.message) || ev.reason || "");
    if (m.includes("A listener indicated an asynchronous response")) ev.preventDefault();
  });

  // ====== DEV / Pago ======
  window.__DEV_MODE = window.__DEV_MODE || false;
  window.__DEV_ON   = function(){ window.__DEV_MODE = true; console.info("DEV ON: generar PDF sin pago."); };
// Auto-dev por querystring
// Auto-dev por querystring (limpia ?dev=1 tras activarlo)
try {
  const _u = new URL(location.href);
  if (_u.searchParams.get("dev") === "1") {
    // Activa el modo DEV una sola vez
    window.__DEV_ON();

    // Limpia el flag para que NO reaparezca en recargas
    _u.searchParams.delete("dev");
    history.replaceState({}, "", _u);

    // (Opcional) desbloquea UI como si estuviera pagado
    window.hasPaid = true;
    localStorage.setItem(LSKEY + "_paid", "true");
    localStorage.setItem(LSKEY + "_paid_bind", (typeof bindStr === "function") ? bindStr() : "");
    localStorage.setItem(STEP_K, "3");

    // Re-sincroniza la tarjeta de pago (si ya están definidas)
    gateDownload?.();
    refreshPayUI?.();
  }
} catch (e) {}





  // ====== Carga jsPDF ======
  async function ensurePDFLibs(){
    if (window.jspdf && window.jspdf.jsPDF) return;
    const src = "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js";
    await new Promise((ok,ko)=>{ const s=document.createElement('script'); s.src=src; s.onload=ok; s.onerror=ko; document.head.appendChild(s); });
    if (!window.jspdf || !window.jspdf.jsPDF) throw new Error("No se pudo cargar jsPDF.");
  }

  // ====== Parámetros “notaría” ======
  const NT = {
    FONT: "times",
    FONT_SIZE: 12,
    LINEH: 18,
    PAGE: { margin: 85, bottomSafe: 160 }, // pie amplio; evita invasión de firmas
    COLOR: { text:"#0f172a", brand:"#1f2937", line:"#d2d6e0" }
  };
  const EUR = new Intl.NumberFormat('es-ES', { style: 'currency', currency: 'EUR' });

  // ====== Helpers tipográficos / maquetación ======
  function setFont(doc, weight, size){ doc.setFont(NT.FONT, weight==="bold"?"bold":"normal").setFontSize(size ?? NT.FONT_SIZE); }
  function sanitize(s){ return String(s||"").replace(/\u00A0/g," ").replace(/[\u2013\u2014]/g,"-"); }
  function hr(doc, x, y, w){ doc.setDrawColor(NT.COLOR.line); doc.setLineWidth(0.6); doc.line(x, y, x+w, y); }
  function paginate(doc, S, needed){
    const pageH = doc.internal.pageSize.getHeight(), bottom = pageH - NT.PAGE.bottomSafe;
    if (S.y + needed <= bottom) return false;
    doc.addPage(); S.y = NT.PAGE.margin; return true;
  }
  

function flowPara(doc, text, x, y, w, opts = {}) {
  opts.S = opts.S || { y };
  const lines = doc.splitTextToSize(sanitize(text), w);
  const lh = opts.lh || NT.LINEH;
  const minNextLines = 2; // No dejar 1 línea suelta en la página siguiente

  let i = 0;
  while (i < lines.length) {
    const pageH = doc.internal.pageSize.getHeight();
    const bottom = pageH - NT.PAGE.bottomSafe;
    const roomLines = Math.floor((bottom - opts.S.y) / lh);
    const remain = lines.length - i;

    // Si no cabe ni una línea más, abre página ya
    if (roomLines <= 0) { doc.addPage(); opts.S.y = NT.PAGE.margin; continue; }

    // Por defecto, imprimimos lo que quepa en esta página
    let take = Math.min(roomLines, remain);

    // Anti-viudas: si al imprimir 'take' líneas, queda SOLO 1 para la próxima,
    // movemos 1 de las que cabían a la página nueva, para que queden >=2 líneas allí.
    if (remain > roomLines && (remain - roomLines) < minNextLines) {
      const falta = minNextLines - (remain - roomLines); // normalmente 1
      take = Math.max(0, take - falta);
    }

    // Si por el ajuste no tomamos ninguna, abrimos página y seguimos
    if (take === 0) { doc.addPage(); opts.S.y = NT.PAGE.margin; continue; }

    // Pinta 'take' líneas en esta página
    for (let k = 0; k < take; k++) {
      doc.text(lines[i + k], x, opts.S.y, { maxWidth: w, align: (opts.align || "left") });
      opts.S.y += lh;
    }
    i += take;

    // Si quedan líneas, abrimos página para continuar
    if (i < lines.length) { doc.addPage(); opts.S.y = NT.PAGE.margin; }
  }
  return opts.S.y;
}

  // Cabecera de sección con línea **solo** en 4 títulos
  function band(doc, title, x, S, w){
    setFont(doc,"bold",12.5); doc.setTextColor(NT.COLOR.brand);
    const T = String(title).toUpperCase();
    doc.text(T, x, S.y);
    doc.setTextColor(NT.COLOR.text);
    S.y += 14;
    const needLine = (
  T==="CONTRATO DE ARRENDAMIENTO DE HABITACIÓN" ||
  T.startsWith("CONDICIONES ESPECÍFICAS") || // incluye (CONT.)
  T==="CLÁUSULAS" ||
  T==="ANEXO I — INVENTARIO"
);

    if (needLine){ hr(doc, x, S.y, w); S.y += 14; }
    return S.y;
  }
  // Cabecera “suave” (SIN línea)
  function bandSoft(doc, title, x, S, w){
     const minNextLines = 2;                 // ← queremos al menos 2 líneas del cuerpo tras el título
  const titleBlock   = 16;                // altura que consume el título “suave”
  const pageH  = doc.internal.pageSize.getHeight();
  const bottom = pageH - NT.PAGE.bottomSafe;
  if (S.y + titleBlock + (minNextLines * NT.LINEH) > bottom){
    doc.addPage(); S.y = NT.PAGE.margin;  // abrir página para no dejar el título huérfano
  }
  setFont(doc,"bold",12.5);
  doc.setTextColor(NT.COLOR.brand);
  doc.text(String(title).toUpperCase(), x, S.y);
  doc.setTextColor(NT.COLOR.text);
  S.y += titleBlock;
  setFont(doc,"normal");                  // el párrafo debajo se escribe en normal
  return S.y;
 }

  // ====== Fila clave:valor (Zonas/Servicios en horizontal) ======
  function rowKV(doc, key, value, x, w, S){
    const keyW=160, lh=NT.LINEH, xVal = x + keyW, wVal = w - keyW;

    paginate(doc, S, lh);
    setFont(doc,"bold"); doc.setTextColor(NT.COLOR.brand); doc.text(sanitize(key)+":", x, S.y);
    setFont(doc,"normal"); doc.setTextColor(NT.COLOR.text);

    if (Array.isArray(value) && value.length && /Zonas comunes incluidas|Servicios incluidos/i.test(key)){
      const lines = doc.splitTextToSize(sanitize(value.join(" · ")), wVal);
      for (let i=0; i<lines.length; i++){ paginate(doc, S, lh); doc.text(lines[i], xVal, S.y, {maxWidth:wVal}); S.y += lh; }
      S.y += 6; return S.y;
    }

    if (Array.isArray(value) && value.length){
      const b="• ", bW = doc.getTextWidth(b);
      for (let i=0; i<value.length; i++){
        const lines = doc.splitTextToSize(sanitize(value[i]||"—"), wVal - bW);
        for (let li=0; li<lines.length; li++){
          paginate(doc,S,lh);
          if (li===0){ doc.text(b, xVal, S.y); doc.text(lines[li], xVal+bW, S.y, {maxWidth:wVal-bW}); }
          else        { doc.text(lines[li],      xVal+bW, S.y, {maxWidth:wVal-bW}); }
          S.y += lh;
        }
      }
    }else{
      const lines = doc.splitTextToSize(sanitize(value||"—"), wVal);
      for (let i=0; i<lines.length; i++){ paginate(doc, S, lh); doc.text(lines[i], xVal, S.y, {maxWidth:wVal}); S.y += lh; }
    }
    S.y += 6; return S.y;
  }

  // ====== Tabla del Anexo — sin líneas verticales, sin zebra ======
  function tableSimple(doc, headers, rows, x, S, w){
    const lh = NT.LINEH, padX=4;
    paginate(doc,S,lh);
    setFont(doc,"bold"); doc.setTextColor(NT.COLOR.brand);
    const colW = headers.map((_,i)=> (i===0? w*0.5 : (i===1? w*0.18 : w*0.32)));
    let cx=x; headers.forEach((h,i)=>{ doc.text(String(h), cx, S.y); cx += colW[i]; });
    setFont(doc,"normal"); doc.setTextColor(NT.COLOR.text);
    S.y += 16;

    rows.forEach(cols=>{
      const cellLines = cols.map((t,i)=> doc.splitTextToSize(sanitize(String(t||"—")), colW[i]-padX*2));
      const maxL = Math.max.apply(null, cellLines.map(a=>a.length));
      for(let li=0; li<maxL; li++){
        paginate(doc,S,lh);
        let cx2=x;
        cellLines.forEach((arr,i)=>{ doc.text(arr[li]||"", cx2, S.y, {maxWidth: colW[i]-padX*2}); cx2 += colW[i]; });
        S.y += lh;
      }
      S.y += 6;
    });
    return S.y;
  }

  // ====== Firmas ======
  function drawSignaturesFooter(doc, loc, arrendador, inquilino){
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const m     = NT.PAGE.margin;
    const ySign = pageH - 220;
    const gap=48, colW=(pageW - 2*m - gap)/2;

    setFont(doc,"bold");   doc.text(sanitize(arrendador||" "), m, ySign - 8);
    setFont(doc,"normal"); doc.text("Arrendador/a", m, ySign + 20);
    doc.setLineWidth(0.9); doc.line(m, ySign, m + colW, ySign);

    const x2 = m + colW + gap;
    setFont(doc,"bold");   doc.text(sanitize(inquilino||" "), x2, ySign - 8);
    setFont(doc,"normal"); doc.text("Inquilino/a", x2, ySign + 20);
    doc.setLineWidth(0.9); doc.line(x2, ySign, x2 + colW, ySign);

    const hoy = new Date();
    const fES = hoy.toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"});
    doc.text(`En ${sanitize(loc||"________")}, a ${fES}`, m, ySign + 100);
  }
  function reserveSignatures(doc, S, minGap=90){
    const pageH = doc.internal.pageSize.getHeight();
    const ySignTop = (pageH - 220);
    if (S.y > (ySignTop - minGap)){ doc.addPage(); S.y = NT.PAGE.margin; }
  }
  function addPageNumbers(doc){
    const n = doc.getNumberOfPages();
    for (let i=1; i<=n; i++){
      doc.setPage(i);
      setFont(doc,"normal",10);
      const pageW = doc.internal.pageSize.getWidth(), pageH = doc.internal.pageSize.getHeight();
      const label = `Página ${i} / ${n}`, width = doc.getTextWidth(label);
      doc.text(label, (pageW-width)/2, pageH-30);
    }
  }
function drawPaidSealBottomRight(doc, opts={}){
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const MARGIN = (opts && typeof opts.margin === "number") ? opts.margin : 56;
  const R = 24; // radio del sello
  const cx = W - MARGIN - R;
  const cy = H - 34 - R;

  const main = (opts.main || "PAGO VERIFICADO").toUpperCase();
  const sub  = (opts.sub  || "DOCUMENTO ORIGINAL").toUpperCase();

  // Colores/estilo
  doc.setTextColor(200, 30, 30);
  doc.setDrawColor(200, 30, 30);
  doc.setLineWidth(1.2);

  // Aro exterior
  doc.circle(cx, cy, R, "S");

  // Aro interior discontinuo
  if (doc.setLineDash) doc.setLineDash([2.2, 1.8], 0);
  doc.setLineWidth(0.8);
  doc.circle(cx, cy, R - 5.5, "S");
  if (doc.setLineDash) doc.setLineDash([], 0);

  // Check central
  doc.setLineWidth(2.2);
  doc.setLineCap("round");
  doc.line(cx - 7, cy + 0, cx - 1, cy + 6);
  doc.line(cx - 1, cy + 6, cx + 9, cy - 6);

  // Texto
setFont(doc,"bold",9);
  const tw = doc.getTextWidth(main);
  doc.text(main, cx - tw/2, cy - 10);

  doc.setLineWidth(0.6);
  doc.line(cx - (R - 6), cy - 7.5, cx + (R - 6), cy - 7.5);

 setFont(doc,"normal",7.5);
  const tw2 = doc.getTextWidth(sub);
  doc.text(sub, cx - tw2/2, cy + 13);
}

  function getClauseTextFromUI(c){ try{ return (window.langMode === "claro" ? (c.C || c.J || c.text) : (c.J || c.C || c.text)); }catch(e){ return c.text || ""; } }
  
function buildClausesFromUI(){
  try{
    const base   = (window.CLAUSES_MANDATORY && window.CLAUSES_MANDATORY.length) ? window.CLAUSES_MANDATORY : (typeof CLAUSES_MANDATORY!=="undefined" ? CLAUSES_MANDATORY : []);
    const extras = (window.CLAUSES_EXTRA && window.CLAUSES_EXTRA.length) ? window.CLAUSES_EXTRA : (typeof CLAUSES_EXTRA!=="undefined" ? CLAUSES_EXTRA : []);
    const sel = (window.selectedClauses ? Array.from(window.selectedClauses) : []);
    const map = new Map(extras.map(c=>[c.id,c]));
    const out = [];
    base.forEach(c => out.push([c.title || "Cláusula", getClauseTextFromUI(c)]));
    sel.forEach(id => { const c = map.get(id); if (c) out.push([c.title || "Cláusula", getClauseTextFromUI(c)]); });
     // DEDUP por título (norm + alias para ruidos/convivencia)
    const alias = new Map([
      ["normas de convivencia y ruidos","ruidos-convivencia"],
      ["ruidos y convivencia","ruidos-convivencia"]
    ]);
    const norm = s => String(s||"").toLowerCase()
       .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
       .replace(/[^a-z0-9 ]+/g," ").replace(/\s+/g," ").trim();
    const seen = new Set(), dedup = [];
    for (const [title, text] of out){
      const k0 = norm(title); const k = alias.get(k0) || k0;
      if (seen.has(k)) continue; seen.add(k); dedup.push([title, text]);
    }
    if (dedup.length) return dedup;  }catch(e){}
  return [["Objeto y partes","..."],["Duración","..."],["Renta y pagos","..."]];
}


  // ====== Núcleo PDF ======
  async function __genPDF(force, opts = {}){const get = (id) => (document.getElementById(id)?.value || "")
                       .trim()
                       .replace(/\s+/g, " ");
    if (!window.hasPaid && !force && !window.__DEV_MODE){ alert("Completa el pago para habilitar la descarga."); return false; }
    await ensurePDFLibs();
    const jsPDF = window.jspdf.jsPDF;

    try{
      const doc = new jsPDF({ unit:"pt", format:"a4" });
      setFont(doc,"normal",NT.FONT_SIZE);

      const pageW = doc.internal.pageSize.getWidth();
      const m  = NT.PAGE.margin, W = pageW - m*2;
      const S  = { y: NT.PAGE.margin };


      // ===== Título principal (con línea) =====
      setFont(doc,"bold",15.5);
      S.y = band(doc, "CONTRATO DE ARRENDAMIENTO DE HABITACIÓN", m, S, W);

      // Marco legal (sin línea)
      setFont(doc,"normal");
      S.y = flowPara(doc,
        "El arrendamiento de habitación suele regirse por el Código Civil (arts. 1542 y ss.), al no encajar en el concepto de arrendamiento de vivienda del art. 2 LAU. Existen resoluciones con criterios distintos; este contrato se formula bajo régimen civil salvo pacto en contrario.",
        m, S.y, W, { S, lh: NT.LINEH, align: "left" }
      );
      S.y += 8;

      const g   = id => (document.getElementById(id)?.value || "");
      const N   = v  => (v||"").toUpperCase().replace(/\s+/g,"");
      const fmt = v  => v ? new Date(v+"T00:00:00").toLocaleDateString("es-ES",{day:"numeric",month:"long",year:"numeric"}) : "—";

      // ===== Partes (SIN línea) =====
      S.y = bandSoft(doc,"Partes", m, S, W);
      rowKV(doc, "Arrendador/a", g("arrendador"), m, W, S);
      rowKV(doc, "DNI/NIE",      N(g("dniArrendador")), m, W, S);
      rowKV(doc, "Inquilino/a",  g("inquilino"), m, W, S);
      rowKV(doc, "DNI/NIE",      N(g("dniInquilino")), m, W, S);

      // ===== Inmueble (SIN línea) =====
      S.y = bandSoft(doc,"Inmueble", m, S, W);
      rowKV(doc, "Dirección", g("direccion"), m, W, S);
      rowKV(doc, "Localidad", g("localidad"), m, W, S);

      // ===== Condiciones (SIN línea) =====
      S.y = bandSoft(doc,"Condiciones", m, S, W);
      rowKV(doc, "Duración",        (g("duracion") || "—")+" meses", m, W, S);
      rowKV(doc, "Inicio del plazo", fmt(g("fechaInicio")), m, W, S);
      rowKV(doc, "Fin del plazo",    fmt(g("fechaFin")), m, W, S);
      rowKV(doc, "Renta mensual",    (g("renta")  ? EUR.format(Number(g("renta")))  : "—"), m, W, S);
      rowKV(doc, "Fianza",           (g("fianza") ? EUR.format(Number(g("fianza"))) : "—"), m, W, S);

      // ===== Condiciones específicas (CON línea) =====
      const zonas = Array.from(document.querySelectorAll('input[name="zc"]:checked')).map(e=>e.value);
      const serv  = [];
      if (document.getElementById("incAgua")?.checked) serv.push("Agua");
      if (document.getElementById("incLuz")?.checked)  serv.push("Luz");
      if (document.getElementById("incGas")?.checked)  serv.push("Gas");
      if ((document.getElementById("wifi")?.value||"no")==="si") serv.push("Wi-Fi");
      const fumar = ((document.getElementById("fumar")?.value||"no")==="si") ? "Permitido" : "No permitido";
      const invOn = !!document.getElementById("anexoInventario")?.checked;

      S.y += 8; // aire por arriba
               S.y = band(doc,"Condiciones específicas", m, S, W);
      rowKV(doc, "Zonas comunes incluidas", zonas.length? zonas : ["—"], m, W, S);
      rowKV(doc, "Servicios incluidos",     serv.length?  serv  : ["—"], m, W, S);
      rowKV(doc, "Política de fumar",       fumar, m, W, S);

      if (invOn){
        const pageH  = doc.internal.pageSize.getHeight();
        const bottom = pageH - NT.PAGE.bottomSafe;
        const willJump = (S.y + NT.LINEH) > bottom; // solo necesitamos 1 línea
        if (willJump){
          doc.addPage(); S.y = NT.PAGE.margin;
          S.y = band(doc, "Condiciones específicas (cont.)", m, S, W);
        }
        rowKV(doc, "Acceso al inventario", "Sí (Anexo I — Inventario)", m, W, S);
      }

      // ===== Cláusulas (CON línea) =====
      const claus = buildClausesFromUI();
	// ——— REUNIDOS / INTERVIENEN / EXPONEN ———
S.y += 6; S.y = bandSoft(doc, "REUNIDOS", m, S, W);
S.y = flowPara(
  doc,
  [
    `De una parte, ${get("arrendador")} (DNI/NIE ${get("dniArrendador")}).`,
    `De otra parte, ${get("inquilino")} (DNI/NIE ${get("dniInquilino")}).`
  ].join("\n"),
  m,
  S.y,
  W,
  { S, lh: NT.LINEH, align: "left" }
);

S.y += 6; S.y = bandSoft(doc, "INTERVIENEN", m, S, W);
S.y = flowPara(
  doc,
  [
    `${get("arrendador")} interviene en su propio nombre y derecho como parte arrendadora.`,
    `${get("inquilino")} interviene en su propio nombre y derecho como parte arrendataria.`
  ].join("\n"),
  m,
  S.y,
  W,
  { S, lh: NT.LINEH, align: "left" }
);


  S.y += 6; S.y = bandSoft(doc, "EXPONEN", m, S, W);
  // Datos específicos de la habitación (sin backticks anidados)
const roomBits = [
  (get("habId")
    ? `Habitación: ${get("habId")}${ get("habPlanta") ? " (" + get("habPlanta") + ")" : "" }.`
    : null),
  (get("habM2")
    ? `Superficie aproximada: ${get("habM2")} m².`
    : null),
  ((get("habAmueblada")==="si" || get("habAmueblada")==="no")
    ? `Amueblada: ${get("habAmueblada")==="si" ? "Sí" : "No"}.`
    : null),
  (get("habDescripcion")
    ? `Descripción: ${get("habDescripcion")}.`
    : null)
].filter(Boolean);


S.y = flowPara(
  doc,
  [
    `Que la parte arrendadora es propietaria/usufructuaria de la vivienda sita en ${get("direccion")} (${get("localidad")}).`,
    `Que se arrienda la habitación identificada y descrita a continuación para uso exclusivo del arrendatario, con derecho de uso a las zonas comunes acordadas.`,
    ...roomBits
  ].join("\n"),     // (opcional) unimos líneas
  m,
  S.y,
  W,
  { S, lh: NT.LINEH, align: "left" }
);


// (A partir de aquí continúa con:)

      S.y += 8; // aire por arriba
               S.y = band(doc,"Cláusulas", m, S, W);
      const __oldSafe = NT.PAGE.bottomSafe;
NT.PAGE.bottomSafe = 140;
       for (let i = 0; i < claus.length; i++) {
  const [tit, cuerpo] = claus[i];
  const lines   = doc.splitTextToSize(sanitize(cuerpo), W);
  const lh      = NT.LINEH;

  // >>> espacios controlados
  const TITLE_GAP = 14;   // aire entre título y texto (antes: 10)
  let AFTER_GAP = 10;   // aire al final de cada cláusula (antes: 8)

  // Cálculo para decidir salto de página antes de pintar esta cláusula
  const neededHeight = TITLE_GAP + (lines.length * lh) + AFTER_GAP;
  const bottom  = doc.internal.pageSize.getHeight() - NT.PAGE.bottomSafe;
  const remain  = bottom - S.y;

  // Mostrar al menos título + 2 líneas en la misma página
  const minShow = TITLE_GAP + (2 * lh);
  if (remain < Math.min(neededHeight, minShow)) {
    doc.addPage(); S.y = NT.PAGE.margin;
  }


  // Título
  setFont(doc, "bold"); paginate(doc, S, lh);
  doc.text(`${i + 1}. ${tit}`, m, S.y);
  S.y += TITLE_GAP;

  // Cuerpo
  setFont(doc, "normal");
  S.y = flowPara(doc, cuerpo, m, S.y, W, { S, lh, align: "left" });
  S.y += AFTER_GAP;
}
NT.PAGE.bottomSafe = __oldSafe;

      // ===== Firmas =====
      reserveSignatures(doc, S, 12);
      drawSignaturesFooter(doc, g("localidad"), g("arrendador"), g("inquilino"));

      // ===== Anexo I =====
      const invTxt = (document.getElementById("inventarioTxt")?.value || "");
      const items  = invOn ? String(invTxt)
        .split(/\r?\n/)
        .map(s=>s.trim()).filter(Boolean)
        .map(l=>{
          const p = l.split(/\s*[|;,\/—-]\s*/);
          return [p[0]||"—", p[1]||"—", p[2]||""];
        }) : [];

      if (items.length){
        doc.addPage(); S.y = NT.PAGE.margin;
        S.y = band(doc, "ANEXO I — INVENTARIO", m, S, W);
        tableSimple(doc, ["Elemento","Estado","Observaciones"], items, m, S, W);
      }

// Si el inventario está activo y el usuario quiere sello, estamparlo aquí
if (opts?.wantSealOnInventory) {
  drawPaidSealBottomRight(doc);
}


      // ===== Numeración =====
      addPageNumbers(doc);

      // Guardar
      try{ doc.save("Contrato-habitacion.pdf"); }
      catch (e){const blob=doc.output('blob'); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download="Contrato-habitacion.pdf"; document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=>URL.revokeObjectURL(url), 15000);
      }
      return true;

    }catch(err){
      console.error(err);
      alert("No se pudo generar el PDF. Revisa la consola.");
      return false;
    }
  }

  // API pública / botón
  window.generarPDF = function(forceOverride){
   const force = !!forceOverride || !!window.__DEV_MODE;
   const invOn = !!document.getElementById("anexoInventario")?.checked;
   const wantSeal = invOn && (
     (typeof shouldSeal === "function") ? shouldSeal()
     : (localStorage.getItem(LSKEY + "_seal") === "1")
   );
   return __genPDF(force, { wantSealOnInventory: wantSeal });
 };
  window.generarPDFForce = function(){ return __genPDF(true); };

  document.getElementById('btnDownload')?.addEventListener('click', ()=>{ void generarPDF(); });
  try { refreshPayUI(); } catch (e) {}
  </script>
  <!-- === PDF: FIN === -->

  <!-- === PayPal form FUERA del wizard (POST) === -->
<!-- PayPal NCP — Habitación -->
<form id="ppNcpForm"
      action="https://www.paypal.com/ncp/payment/FQE2RL234MT9C"
      method="post" target="_blank"></form>

  <form id="paypalClassicForm" action="https://www.paypal.com/cgi-bin/webscr" method="POST" target="_top" style="display:none">
    <input type="hidden" name="cmd" value="_xclick">
    <input type="hidden" name="business" value="oscargrubio@live.com">
    <input type="hidden" name="item_name" value="Contrato habitación PRO (PDF)">
    <input type="hidden" name="currency_code" value="EUR">
    <input type="hidden" name="amount" value="1.00">
    <input type="hidden" name="no_note" value="1">
    <input type="hidden" name="no_shipping" value="1">
    <input type="hidden" id="ppReturn" name="return" value="">
    <input type="hidden" id="ppCancel" name="cancel_return" value="">
  </form>
<script>
// ====== HABITACIÓN — Biblioteca reforzada (J/C) ======
(function(){
  if (!window.CLAUSES_MANDATORY) window.CLAUSES_MANDATORY = [];
  if (!window.CLAUSES_EXTRA) window.CLAUSES_EXTRA = [];

  const MUST = [
    {id:"objeto_hab", title:"Objeto y destino (habitación)", 
      J:"Se arrienda habitación amueblada identificada en el contrato, con derecho de uso de las zonas comunes pactadas. La habitación se arrienda como cuerpo cierto. Uso conforme a su destino.",
      C:"Habitación amueblada con uso de zonas comunes. Uso adecuado."},
    {id:"duracion_hab", title:"Duración y finalización", 
      J:"Duración la indicada (temporal). Al vencimiento, la posesión se devolverá libre de ocupantes, sin requerimiento previo, salvo tácita reconducción.",
      C:"Dura lo pactado. Al final, devuelves la habitación sin ocupar."},
    {id:"precio_fianza_hab", title:"Renta y fianza", 
      J:"Renta mensual anticipada dentro de los cinco primeros días. Fianza equivalente a una mensualidad; no compensa impagos y se devuelve al término si no hay cantidades pendientes.",
      C:"Pagas a primeros de mes. Fianza de un mes; no sirve para impagos."}
  ];
MUST.push({
  id:"desist_preaviso",
  title:"Desistimiento y preaviso",
  J:"Cualquiera de las partes podrá desistir del contrato mediando preaviso por escrito con una antelación mínima de 30 días, sin perjuicio de las cantidades devengadas hasta la fecha y de la liquidación final que corresponda.",
  C:"Puedes terminar el contrato avisando por escrito con 30 días de antelación. Se liquidan los importes pendientes."
});
// 1) Estado de entrega e inventario
MUST.push({
  id:"estado_inventario",
  title:"Estado de entrega e inventario",
  J:"La habitación se entrega en buen estado de uso y limpieza, con el mobiliario y enseres descritos en el inventario que se incorpora como anexo y es firmado por ambas partes. A la finalización del contrato, el arrendatario devolverá la posesión en el mismo estado, respondiendo de los daños distintos del desgaste por uso ordinario.",
  C:"Se entrega limpia y en buen estado, con los muebles del inventario firmado. Al irte, debes devolverla igual; pagarás daños más allá del uso normal."
});

// 2) Resolución por incumplimiento grave
MUST.push({
  id:"resolucion_incumplimiento",
  title:"Resolución por incumplimiento grave",
  J:"Serán causa de resolución, entre otras, el impago de la renta o de la fianza/actualizaciones, el subarriendo o cesión sin consentimiento, la realización de actividades molestas o ilícitas, los daños graves, o el incumplimiento de las obligaciones esenciales. En tales casos, el arrendador podrá declarar resuelto el contrato y exigir la restitución de la habitación y las indemnizaciones que procedan.",
  C:"Si no pagas, subarriendas sin permiso, causas molestias o daños graves o incumples lo esencial, el propietario puede dar por terminado el contrato y pedir la devolución de la habitación con daños y perjuicios."
});


  const EXTRA = [
    {id:"acceso", title:"Derecho de acceso del arrendador", 
      J:"El arrendatario no impedirá el acceso del arrendador a zonas comunes y a habitaciones no arrendadas cuando sea necesario. Su vulneración faculta la resolución y el desahucio, con resarcimiento de daños.",
      C:"No bloquees el acceso del propietario a comunes/habitaciones libres."},
    {id:"electrodomesticos", title:"Uso de electrodomésticos",
       J:"El arrendatario utilizará los electrodomésticos e instalaciones de la vivienda conforme a su finalidad e instrucciones del fabricante, manteniéndolos en correcto estado de limpieza. Responderá de los daños ocasionados por uso negligente o inadecuado.",
       C:"Usa los electrodomésticos correctamente y límpialos; respondes de daños por mal uso."},
    {id:"cesion_subarr", title:"Cesión y subarriendo", 
      J:"Prohibidos sin consentimiento escrito del arrendador. Su incumplimiento faculta la resolución.",
      C:"No cedas ni subarriendes sin permiso."},
    {id:"penal_posesion", title:"Penalización por no devolver la posesión", 
      J:"Si no se entrega la posesión en la fecha de fin, penalización equivalente al doble de la renta vigente por el tiempo de retraso.",
      C:"Si no devuelves a tiempo, pagas el doble por los días de retraso."},
    {id:"notifica_email", title:"Notificaciones por correo electrónico", 
      J:"Serán válidas las notificaciones enviadas a los domicilios designados y/o a los correos electrónicos facilitados por las partes.",
      C:"Avisos válidos al email indicado."},
    {id:"masc_ovc", title:"MASC previo a la vía judicial", 
      J:"Cuando sea obligatorio acudir a un MASC previo, las partes se someten al que corresponda en derecho. Si no es obligatorio, renuncian a MASC y se someten a la jurisdicción ordinaria.",
      C:"Si la ley exige MASC, se usa; si no, a juzgados."}
  ];
EXTRA.push({
  id:"seguro_rc",
  title:"Seguro de responsabilidad civil (recomendado)",
  J:"El arrendatario mantendrá durante la vigencia del contrato una póliza de responsabilidad civil que cubra los daños causados a terceros en la vivienda y zonas comunes, exhibiéndola al arrendador cuando sea requerido.",
  C:"Mantén un seguro de RC que cubra daños a terceros y enséñalo si te lo piden."
});
// 1) Límites de consumo y regularización de suministros
EXTRA.push({
  id:"limite_suministros",
  title:"Límites de consumo y regularización de suministros",
  J:"Cuando los suministros estén incluidos en la renta, las partes fijan un consumo razonable máximo mensual por concepto (electricidad/agua/gas/Internet). Los excesos sobre el umbral pactado se regularizarán mensualmente contra justificantes, repartiéndose entre los inquilinos a partes iguales salvo pacto distinto.",
  C:"Si los suministros van incluidos hay un tope razonable; lo que pase del tope se regulariza con facturas y se reparte."
});

// 2) Actualización anual de la renta (si se pacta)
EXTRA.push({
  id:"actualizacion_renta",
  title:"Actualización anual de la renta (si se pacta)",
  J:"La renta podrá actualizarse anualmente en la fecha de cada aniversario, conforme al mecanismo que acuerden las partes y dentro de los límites legales vigentes. En defecto de pacto expreso, no habrá actualización.",
  C:"Cada año, si lo acordáis por escrito, puede actualizarse la renta dentro de los topes legales; si no se pacta, no se actualiza."
});


  // Inyectamos manteniendo tus IDs
  window.CLAUSES_MANDATORY = MUST; // sobrescribe la lista base con la versión de 'habitación'
  window.CLAUSES_EXTRA = [...EXTRA, ...window.CLAUSES_EXTRA];
})();
</script>
<script>
(function(){
  function valOf(id){ return (document.getElementById(id)||{}).value || ""; }
  function isOn(sel){ const el=document.querySelector(sel); return !!(el && (el.checked || el.classList?.contains("active"))); }
  function collectHabitacion(){
    const zonas = Array.from(document.querySelectorAll('#zonasChips input[name="zc"]:checked')).map(i=>i.value);
    const sumis = {
      incAgua: document.getElementById("incAgua")?.checked || false,
      incLuz:  document.getElementById("incLuz")?.checked  || false,
      incGas:  document.getElementById("incGas")?.checked  || false,
    };
    return {
      direccion: valOf("direccion"),
      arrendador: valOf("arrendador"),
      dniArrendador: valOf("dniArrendador"),
      inquilino: valOf("inquilino"),
      dniInquilino: valOf("dniInquilino"),
      localidad: valOf("localidad"),
      duracion: valOf("duracion"),
      fechaInicio: valOf("fechaInicio"),
      fechaFin: valOf("fechaFin"),
      renta: valOf("renta"),
      fianza: valOf("fianza"),
      wifi: (document.getElementById("wifi")||{}).value || "no",
      fumar: (document.getElementById("fumar")||{}).value || "no",
      zonas,
       sumis: sumis
    };
  }

  function parseInventario(){
    const raw = (document.getElementById("inventarioTxt")||{}).value || "";
    return raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean).map(line=>{
      const parts = line.split(/\s*[|;/—-]\s*|,\s*|\t/).map(s=>s.trim()).filter(Boolean);
      return parts.join(" — ");
    });
  }

async function generarPDFHabitacion(force=false){
  if (!window.hasPaid && !force && !window.__DEV_MODE){
    alert("Completa el pago para habilitar la descarga."); return;
  }
  if (__downloading) return;
  __downloading = true;
  try {
    const data    = collectHabitacion();
    const clauses = (window.buildClausesFromUI ? window.buildClausesFromUI() : []);
    const anexos  = {};
    if (document.getElementById("anexoInventario")?.checked){
      anexos.inventario = parseInventario();
    }

    const wantSeal = !!anexos.inventario && shouldSeal();

    if (window.__NT_BUILD_PDF){
      const doc = await window.__NT_BUILD_PDF("habitacion", data, clauses, anexos);
      if (wantSeal) drawPaidSealBottomRight(doc); // sello en la última (Anexo I)
      doc.save("Contrato_habitacion.pdf");
    } else {
      await __genPDF(true, { wantSealOnInventory: wantSeal }); // fallback interno con sello
    }
  } finally {
    __downloading = false;
  }
}
})();



</script>


<script>
(() => {
  // Claves de Habitación (sin cambiarlas)
  const LSKEY  = (window.LSKEY || "contrato_habitacion_v2");
  const STEP_K = (window.STEP_K || "HAB_STEP");



  // Vincula el pago a los datos núcleo (igual que Vivienda)
  function bindStr(){
    const g=id=> (document.getElementById(id)?.value || "").trim().toUpperCase();
    return JSON.stringify({
      arr:g("arrendador"), dniA:g("dniArrendador"),
      inq:g("inquilino"),  dniI:g("dniInquilino"),
      dir:g("direccion"),  loc:g("localidad"),
      fi:g("fechaInicio"), ff:g("fechaFin"),
      renta:g("renta"),    fianza:g("fianza")
    });
  }
  window.bindStr = bindStr;

  // Si cambian campos clave, invalida pago (como Vivienda)
  ["arrendador","dniArrendador","inquilino","dniInquilino",
   "direccion","localidad","fechaInicio","fechaFin","renta","fianza"]
  .forEach(id=>{
    const el = document.getElementById(id);
    el?.addEventListener("input", ()=>{
      const paidBind = localStorage.getItem(LSKEY+"_paid_bind") || "";
      if (paidBind && paidBind !== bindStr()){
        localStorage.removeItem(LSKEY+"_paid");
        localStorage.removeItem(LSKEY+"_order");
        localStorage.removeItem(LSKEY+"_paid_bind");
        // compat previo
        localStorage.removeItem("HAB_PAID");
        localStorage.removeItem("HAB_ORDER");
        window.hasPaid = false; window.orderId = "";
        gateDownload();
      }
    });
  });

  // Antes de abrir NCP, guarda snapshot temporal SIEMPRE (como Vivienda)
  document.getElementById("ppNcpForm")?.addEventListener("submit", () => {
    try {
      const snap = (typeof serialize==="function") ? serialize() : "{}";
      localStorage.setItem(LSKEY + "_tmp", snap);
      if (typeof saveState === "function") saveState();
      localStorage.setItem(STEP_K, "3");
    } catch (e) {}
  });



  // Muestra/oculta DESCARGAR: solo si pagó y el bind coincide
  function gateDownload(){
    const btn = document.getElementById("btnDownload");
    const paid = (localStorage.getItem(LSKEY+"_paid")==="true")
                 || window.hasPaid===true
                 || localStorage.getItem("HAB_PAID")==="1"; // compat
    const paidBind = localStorage.getItem(LSKEY+"_paid_bind") || "";
    const sameBind = (paidBind && paidBind === bindStr());
    const show = (Number(localStorage.getItem(STEP_K)||"3") === 3 && paid && sameBind);
    if (btn) btn.style.display = show ? "inline-flex" : "none";
    
  }
  window.gateDownload = gateDownload;

  // Retorno PayPal (NCP), como Vivienda
  {
    const url = new URL(location.href);
    if (url.searchParams.get("pago_confirmado") === "1") {
      window.hasPaid = true;
      window.orderId = "PAYPAL-OK";
      localStorage.setItem(LSKEY + "_paid", "true");
      localStorage.setItem(LSKEY + "_order", window.orderId);
      // compat con tu lógica previa
      localStorage.setItem("HAB_PAID", "1");
      localStorage.setItem("HAB_ORDER", window.orderId);

      // Rehidrata snapshot pagado si existe
      try {
        const tmp = localStorage.getItem(LSKEY + "_tmp");
        if (tmp && tmp.length > 50) {
          localStorage.setItem(LSKEY, tmp);
          localStorage.removeItem(LSKEY + "_tmp");
        }
        if (localStorage.getItem(LSKEY) && typeof populate === "function") {
          populate();
          if (typeof refreshResumen === "function") refreshResumen();
          if (typeof refreshPreview === "function") refreshPreview();
if (typeof renderMandatory === "function") renderMandatory();
if (typeof renderClausePicker === "function") renderClausePicker(document.getElementById("clauseSearch")?.value || "");
if (typeof updateClauseCount === "function") updateClauseCount();
if (typeof detectPresetFromSelection === "function" && typeof markPresetChip === "function"){
  const det = detectPresetFromSelection(window.selectedClauses || new Set());
  markPresetChip(localStorage.getItem(PRESET_K) || det);
        }
	}
      } catch (e) {}

      // Vincula pago ↔ datos reales
      try { localStorage.setItem(LSKEY + "_paid_bind", bindStr()); } catch (e) {}

      localStorage.setItem(STEP_K, "3");
      gateDownload();
  refreshPayUI();

      // Limpia el querystring
      try { url.searchParams.delete("pago_confirmado");
            history.replaceState({}, "", url.toString()); } catch (e) {}
    }

    if (url.searchParams.get("pago_cancelado") === "1") {
      localStorage.setItem(STEP_K, "3");
      try { url.searchParams.delete("pago_cancelado");
            history.replaceState({}, "", url.toString()); } catch (e) {}
    }
  }

  // Estado inicial
  document.addEventListener("DOMContentLoaded", gateDownload);
  gateDownload();
})();
</script>

<script>
// === Sello “Pago verificado” (UI + persistencia) ===
(() => {
  const __LS = (typeof window.LSKEY !== "undefined" ? window.LSKEY : "contrato_habitacion_v2");

  // Lo usa el generador de PDF
  window.shouldSeal = function(){ 
    return localStorage.getItem(__LS + "_seal") === "1"; 
  };

  function refreshPayUI(){
    const paid = (localStorage.getItem(__LS+"_paid")==="true")
              || window.hasPaid===true
              || localStorage.getItem("HAB_PAID")==="1";

    const wrap = document.getElementById("sealWrap");
    const cb   = document.getElementById("sealOpt");
    const lab  = document.getElementById("sealToggle");
    if (!wrap || !cb || !lab) return;

    // Visible tras pagar y en Paso 3 (si quieres exigir Inventario: añade && invOn)
    const onStep3 = (typeof window.currentStep === "number"
                      ? window.currentStep === 3
                      : (localStorage.getItem("HAB_STEP") || "1") === "3");

    wrap.style.display = (paid && onStep3) ? "inline-flex" : "none";

    // Estado recordado (por defecto “1” si pagado y aún no hay preferencia)
    let v = localStorage.getItem(__LS + "_seal");
    if (v === null && paid) { v = "1"; localStorage.setItem(__LS + "_seal", "1"); }
    cb.checked = (v === "1");
    lab.classList.toggle('active', cb.checked);
  }

  document.addEventListener("DOMContentLoaded", refreshPayUI);
  window.refreshPayUI = refreshPayUI;
})();
</script>


<script>
(() => {
  const url = new URL(location.href);
  const pp  = url.searchParams.get("pp");
  if (pp === "h" && !/contrato-habitacion\.html$/i.test(location.pathname)) {
    location.replace("contrato-habitacion.html?" + url.searchParams.toString());
  }
})();
</script>



</body>
</html>
